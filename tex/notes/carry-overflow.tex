\documentclass{article}
\usepackage{amssymb}
\usepackage{hyperref}
\input{shortcuts}
\newcommand{\zq}{\mbox{${\bf Z}_{q}$}}
\title{A Note on Carry and Overflow}
\author{Paul Ossientis}

\begin{document}
\maketitle

\section{Introduction}
In this note we assume given a natural number $q=2^{n}$ where 
$n\in\{8,16,32,64\}$. We denote \zq\ the ring of integers modulo $q$. 
The purpose of this note is to provide a formal presentation of the mathematics
underlying some operations of a computer's CPU and explain the notions of {\em
carry} and {\em overflow} within that formal framework. It all starts with the
realization that computer hardware is designed to perfectly perform the
operation of addition $+$ on the ring \zq. There is no approximation,
there is no error, no overflow, the result is always perfect and exact: 
computer hardware naturally operates on \zq. It is also very good at 
inverting bits: so given $x\in\zq$ it can easily compute $\lnot x$.
Furthermore, since $x+\lnot x = q-1$ we have the equality $-x = \lnot x + 1$.
It follows that a CPU can easily (and exactly) compute the opposit $-x$ of 
any $x\in\zq$, simply by incrementing $\lnot x$. Hence we see that not only 
is the addition $+$ a natural primitive of computer hardware, but so is
the subtraction $-$ defined by $x-y = x + (-y)$ for all $x,y\in\zq$.

\begin{defin}\label{carry:star} 
  For all $x\in\zq$, we define $x^{*}$ the unique integer with the property:
    \[
      x^{*} = x\ \mbox{mod}\ q\mbox{\ \ and\ \ }x^{*}\in[0,q[
    \]
\end{defin}

\section{Carry for Addition}
Users of computer hardware are not interested in \zq. One of their first interests
is to perform the operation of addition $+$ on the set of natural numbers \N, 
an operation commonly referred to as {\em unsigned addition} by computer 
scientists. While it is possible (and indeed is a built-in feature of many modern 
computer languages such as Python or Haskell) to handle every possible values 
of \N\ (as permitted by a computer's memory), for historical reasons and the 
purpose of this note on {\em carry} and {\em overflow}, it is important to 
restrict our attention to natural numbers which can be represented as 
{\em unsigned integers} within an $n$-bits register. These {\em representable}
natural numbers are exactly those belonging the interval $[0,q[$ and the
representation is exactly the associated integer modulo $q$. In other words,
the {\em representable} natural numbers are the range of the mapping 
$x\rightarrow x^{*}$ from \zq\ to \N, and for all $x\in\zq$, $x$ is the
representation (in computer hardware) of the natural number $x^{*}$. Now,
given two {\em representable} natural numbers $x^{*}$ and $y^{*}$, the users of 
computer hardware are interested in computing the sum $x^{*} + y^{*}$, while 
their machine only knows about $x+y$. Luckily, the following proposition shows that
computing $x+y$ allows us to infer the value of $x^{*}+y^{*}$, provided the 
latter is also {\em representable}:

\begin{prop}\label{carry:unsigned:add:morphism}
For all $x,y\in\zq$ the following are equivalent:
  \begin{eqnarray*}
    (i)&\ &x^{*} + y^{*}\in [0,q[\\
    (ii)&\ &(x + y)^{*} = x^{*} + y^{*} 
  \end{eqnarray*}
\end{prop}
\begin{proof}
  For all $x\in\zq$, from definition~(\ref{carry:star}) $x^{*}$ is an element 
  of $[0,q[$. It follows that $(i)$ is an immediate consequence of $(ii)$. 
  Conversely, if we assume that $(i)$ is true, then since it is clear that 
  $x^{*} + y^{*} = x + y$ modulo $q$, we conclude from 
  definition~(\ref{carry:star}) that $(x+y)^{*} = x^{*} + y^{*}$, 
  which completes our proof.
\end{proof}

Hence we see that as long as $x^{*}+y^{*}$ is a {\em representable} natural
number, it does not matter that our CPU should only know about addition in \zq:
adding the two representations $x$ and $y$ gives us a representation of 
$x^{*}+y^{*}$ which is as good as we can hope. However, there are cases 
when $x^{*} + y^{*}$ is not a {\em representable} natural number, in which 
case equality~$(ii)$ of proposition~(\ref{carry:unsigned:add:morphism}) 
does not hold. One way to think about this situation is saying that 
{\em the result of $x+y$ is wrong}. As it turns out, there is nothing wrong 
with $x+y$ which is a perfectly correct answer to the question of adding 
two numbers in \zq. However, $x+y$ is not a representation of $x^{*}+y^{*}$, 
and in that sense, it is clearly wrong. This is where the notion of 
{\em carry for addition} naturally comes in:

\begin{defin}\label{carry:unsigned:add:carry}
We call {\em carry for addition} the map $c:\zq\times\zq\rightarrow2$ defined by:
  \[
    c(x,y) = 1  \ \ \Leftrightarrow\ \ x^{*} + y^{*} \not\in[0,q[
  \]
\end{defin}

By convention we denote $2=\{0,1\}$ which is our choice of boolean type, 
and the {\em carry for addition} is therefore a boolean function defined 
on the cartesian product $\zq\times\zq$, the purpose of which
is to flag any situation where the result of $x+y$ is {\em wrong} or (to
phrase it more accurately) any situation where $x+y$ is not a representation 
of the natural number $x^{*}+y^{*}$. 

So we now understand what the {\em carry} is, a notion which we have defined 
in the context of unsigned addition. As we shall see, there will be a notion 
of carry for (unsigned) subtraction, and similar notions for signed addition 
and subtraction (called {\em overflow} rather than {\em carry} for signed 
operations). What all these notions have in common is their purpose: 
to warn a user of computer hardware that the result of a primitive operation 
perfomed by the CPU on elements of \zq\ (which are representations of elements
of \N\ or \Z\ as the case may be), does not yield a representation of the result 
to the corresponding operation on natural numbers or signed integers. In short, 
{\em carry} and {\em overflow} are designed to tell us when the result of an
operation is {\em wrong}.

For those writing computer software, the ability to compute the carry flag 
$c(x,y)$ is crucial, as we need to know when $x+y$ ceases to be an accurate 
representation of the result we care about. For this reason, designers of
computer hardware have made the computation of the carry flag for addition, 
one of the fundamental primitives of a CPU. So whenever an addition $x+y$ is
perfomed, the carry flag will be set or cleared, depending on whether 
$c(x,y)=1$ or $c(x,y)=0$. The ability to test this carry flag and introduce
branching instructions in the code which depend on the outcome is also one
of the primitives of computer hardware. While we have not yet discussed 
the {\em carry} following a subtraction, this carry is essentially the same 
bit being set or cleared after the operation is performed, and as we
shall see the ability to test this flag allows us to compare:


\begin{defin}\label{carry:order:zq}
  Given $x,y\in\zq$ we say that $x\leq y$ \ifand\ $x^{*}\leq y^{*}$.
\end{defin}

Mathematically speaking, the order $\leq$ thus defined on \zq\ may 
not be very interesting as it is not compatible with addition 
(the inequality $x\leq y$ does not imply $x+z\leq y+z$). 
However, it is interesting to us as it is 
a relation which can be tested by a CPU (as mentioned, it can
be tested using the {\em carry for subtraction}). It is also 
interesting because it is defined to perfectly mimic the 
inequality $x^{*} \leq y^{*}$ satisfied or not by the natural 
numbers represented by $x$ and $y$. Note that having defined 
the relation $\leq$ on \zq, we have implicitely defined $>$, 
$\geq$ and $<$, and since we can test these conditions
(the {\em zero} flag allows us to test equality), 
we are able to compute the corresponding binary $\min$ and $\max$ 
functions. So while definition~(\ref{carry:unsigned:add:carry}) 
relies on the quantity $x^{*}+y^{*}$ which we cannot compute,
the following proposition defines the {\em carry for addition} in
terms of conditions which can easily be tested in assembly
language:

\begin{prop}\label{carry:unsigned:add:criterium}
  For all $x,y\in\zq$, the following are equivalent:
    \begin{eqnarray*}
      (i)&\ &c(x,y) = 1\\
      (ii)&\ & x + y < \min(x,y)\\
      (iii)&\ & x + y < \max(x,y)\\
      (iv)&\ & x + y < x\\
      (v) &\ & x + y < y
    \end{eqnarray*}
where $c:\zq\times\zq\rightarrow 2$ is the carry for addition of 
  definition~(\ref{carry:unsigned:add:carry}), and the strict order $<$
  is derived from the relation $\leq$ of 
  definition~(\ref{carry:order:zq}) defined on \zq.
\end{prop}
\begin{proof}
  Since for all $x,y\in\zq$, $\min(x,y)\leq x, y\leq\max(x,y)$ we immediately 
  have the implications $(ii)\Rightarrow(iv)$, $(ii)\Rightarrow(v)$, 
  $(iv)\Rightarrow(iii)$ and $(v)\Rightarrow(iii)$. In order to complete
  the proof, it remains to show that $(i)\Rightarrow(ii)$ and 
  $(iii)\Rightarrow(i)$. We first show that $(i)\Rightarrow(ii)$. So 
  we assume that $c(x,y) = 1$, and need to show that $x+y<\min(x,y)$.
  In other words we need to show that both inequalities $x+y<x$ and 
  $x+y<y$ hold. However from definition~(\ref{carry:unsigned:add:carry}),
  our assumption is equivalent to $x^{*}+y^{*}\not\in[0,q[$, and we know
  from definition~(\ref{carry:star}) that both $x^{*}$ and $y^{*}$ are elements
  of $[0,q[$. It follows that $x^{*}+y^{*}$ must be an element of $[0,2q[$
  without being an element of $[0,q[$. Hence it must be an element of
  $[q,2q[$, from which we see that $x^{*}+y^{*}-q$ is an element of $[0,q[$,
  while being equal to $x+y$ modulo $q$. From definition~(\ref{carry:star})
  it follows that $(x+y)^{*}=x^{*}+y^{*}-q$, and since both $y^{*}-q <0$ and 
  $x^{*}-q<0$ we obtain $(x+y)^{*}<x^{*}$ and $(x+y)^{*}<y^{*}$ which by
  virtue of definition~(\ref{carry:order:zq}) is equivalent to $(x+y)<x$ and 
  $(x+y)<y$ as requested. We now prove that $(iii)\Rightarrow(i)$. So we
  assume that $x+y <\max(x,y)$ and we need to show that $c(x,y)=1$, or
  equivalently that $x^{*}+y^{*}\not\in[0,q[$. However, our assumption
  implies that $x+y<x$ or $x+y<y$. So we shall distinguish two cases:
  first we assume that $x+y<x$. From definiton~(\ref{carry:order:zq}), 
  this means that $(x+y)^{*}<x^{*}$. Hence, it is impossible that 
  $x^{*}+y^{*}\in[0,q[$ as this would imply that $(x+y)^{*}=x^{*}+y^{*}$ 
  (being equal to $x+y$ modulo $q$) and consequently $x^{*}+y^{*}<x^{*}$, 
  yielding the contradiction $y^{*}<0$. Likewise, if we assume that $x+y<y$ 
  then $x^{*}+y^{*}\in[0,q[$ implies the contradiction $x^{*}<0$.
\end{proof}
\section{Carry for Subtraction}
Given two {\em representable} natural numbers $x^{*}$ and $y^{*}$, users of
computer hardware commonly want to compute their difference $x^{*}-y^{*}$. 
Unfortunately, the only result available to them is the difference $x-y\in\zq$
performed by the CPU on their representations $x$, $y$. In light of our
analysis for addition, the first question we should ask is whether $x-y$ 
is a representation of $x^{*}-y^{*}$. As before, as long as the sought out 
result is {\em representable}, the answer is 'yes':
\begin{prop}\label{carry:unsigned:sub:morphism}
  For all $x,y\in\zq$, the following are equivalent:
    \begin{eqnarray*}
      (i)&\ &x^{*}-y^{*}\in[0,q[\\
      (ii)&\ &x^{*}\geq y^{*}\\
      (iii)&\ &(x-y)^{*}=x^{*}-y^{*}
    \end{eqnarray*}
\end{prop}
\begin{proof}
Since both $x^{*}$ and $y^{*}$ are always elements of $[0,q[$, the difference
  $x^{*}-y^{*}$ is always an element of $]-q,q[$. Hence the equivalence between
  $(i)$ and $(ii)$ is clear. It remains to show the equivalence between $(ii)$
  and $(iii)$. First we show $(ii)\Rightarrow(iii)$. So suppose 
  $x^{*} \geq y^{*}$. Since $x^{*}-y^{*}$ is an element of $]-q,q[$, it is
  in fact an element of $[0,q[$ while being equal to $x-y$ modulo $q$. It
  follows from definition~(\ref{carry:star}) that $x^{*}-y^{*}=(x-y)^{*}$
  as requested. Conversely, if we assume that $x^{*}-y^{*}=(x-y)^{*}$ then
  in particular $x^{*}-y^{*}$is an element of $[0,q[$, so $x^{*}\geq y^{*}$.
\end{proof}

This in turn immediately motivates the following definition, whose purpose
it is to highlight any situation where the result of $x-y$ is {\em wrong}, that
is a situation where $x-y$ ceases to be a representation of the difference 
$x^{*}-y^{*}$.

\begin{defin}\label{carry:unsigned:sub:carry}
We call {\em carry for subtraction} the map $c:\zq\!\times\!\zq\rightarrow2$ defined by:
  \[
    c(x,y) = 1  \ \ \Leftrightarrow\ \ x^{*} < y^{*}
  \]
\end{defin}

In similar fashion to proposition~(\ref{carry:unsigned:add:criterium}) we state:

\begin{prop}\label{carry:unsigned:sub:criterium}
  For all $x,y\in\zq$, the following are equivalent:
    \begin{eqnarray*}
      (i)&\ &c(x,y) = 1\\
      (ii)&\ & x < y
    \end{eqnarray*}
where $c:\zq\times\zq\rightarrow 2$ is the carry for subtraction of 
  definition~(\ref{carry:unsigned:sub:carry}), and the strict order $<$
  is derived from the relation $\leq$ of 
  definition~(\ref{carry:order:zq}) defined on \zq.
\end{prop}
\begin{proof}
Immediate from definition~(\ref{carry:unsigned:sub:carry}) and the fact 
that $x<y$ is equivalent $x^{*}<y^{*}$.
\end{proof}

The point of proposition~(\ref{carry:unsigned:sub:criterium}) is to be 
able to validate in software the consistency between testing for the 
carry flag after a subtraction $x-y$, and testing for the condition $x<y$.
Whenever a 'sub x y' or 'cmp x y' instructtion is performed, the carry 
flag should be set if and only if the condition $x<y$ holds.

\section{Overflow for Addition}
Users of computer hardware are not interested in \zq, and they may not be
interested in the set of natural numbers \N\ either. Given two integers 
$u,v\in\Z$ they often want to compute their sums $u+v$, an operation 
commonly referred to as {\em signed addition} by computer scientists.
Unfortunately, as we can guess by now, a CPU has no interstanding of
integers in \Z\ (it only knows about \zq) let alone of how to compute
their sum. We humans have to come up with a trick to obtain the answers
we want from a machine which is limited to operating on \zq. When faced
with operations on \N, we designed a successful strategy: first we 
restricted our domain to a subset of \N\ namely those natural numbers
belonging to $[0,q[$. Then we decided to give every natural number $x^{*}$
of this domain a representation $x$ in \zq. Then we let the CPU operate
on the representations $x$ and $y$ of our chosen natural numbers, 
hoping to obtain a representation of the sum $x^{*} + y^{*}$ or the 
difference $x^{*}-y^{*}$ as the case may be. This strategy works well,
but is not immune to failure, which led to the notions of {\em carry}
for addition and subtraction giving software designers the ability
to know if and when the CPU representations $x+y$ and $x-y$ in \zq\ 
are indeed what they want. We shall now spell out a similar strategy 
for \Z, that of {\em two's complement representation}:

\begin{defin}\label{carry:signed:representable}
We say that $n\in\Z$ is {\em representable} \ifand\ $n\in[-q/2,q/2[$.
\end{defin}
 
Definition~(\ref{carry:signed:representable}) describes our domain. We
have now defined the term {\em representable} in the context of signed 
addition (addition in \Z) which should not be confused with 
{\em representable} in the context of unsigned addition (addition in \N).
A {\em representable} natural number (aka unsigned integer) belongs to 
$[0,q[$, while a {\em representable} integer (aka signed integer) belongs
to $[-q/2,q/2[$. Now given a {\em representable} integer in $[-q/2,q/2[$,
we need to define its representation in \zq:

\begin{defin}\label{carry:signed:2:complement}
The bijection $r:\zq\rightarrow\Z\cap[-q/2,q/2[$ defined by:
  \[
    \forall x\in\zq\ ,\ r(x)=
      \left\{
          \begin{array}{lcr}
          x^{*}&\mbox{\ if\ }&x\in[0,q/2[\\
          x^{*}-q&\mbox{\ if\ }&x\in[q/2,q[
        \end{array}
      \right.
  \]
is called {\em the two's complement representation mapping}. Given $x\in\zq$,
  we say that $x$ is the {\em two's complement representation} of the 
  integer $r(x)\in[-q/2,q/2[$.
\end{defin}

Now consider the simplest case when $q=2^8$. We have $256$ elements of \zq, 
from $0$ to $255$. According to definition~(\ref{carry:signed:2:complement}),
we have $r(0)=0$ and $r(1) = 1$ etc. up to $r(127)=127$. Then we see that 
$r(128)=-128$, $r(129)=-127$, etc. up to $r(255)=-1$. The two's complement
representation of $0\in\Z$ is $0\in\zq$. The two's complement representation
of $-128\in\Z$ is $128\in\zq$ and the two's complement representation of 
$-1\in\Z$ is $255\in\zq$.

\begin{prop}
  The map $r:\zq\rightarrow\Z\cap[-q/2,q/2[$ is indeed a bijection.
\end{prop}
\begin{proof}
First we show that $r$ is injective. So suppose $r(x)=r(y)$ for some 
$x,y\in\zq$. We need to show that $x=y$ or equivalently that 
$x^{*}=y^{*}$. Consider four cases:
  \begin{enumerate}
    \item $x\in[0,q/2[$ and $y\in[0,q/2[$: then $r(x)=x^{*}$ and $r(y)=y^{*}$
      and the equality $r(x)=r(y)$ yields $x^{*}=y^{*}$ as requested.
    \item $x\in[0,q/2[$ and $y\in[q/2,q[$: then $r(x)=x^{*}$ and 
      $r(y)=y^{*}-q$ and the equality $r(x) = r(y)$ yields $x^{*}=y^{*}-q < 0$
      which is a contradiction. Hence this case cannot occur whenever 
      $r(x)=r(y)$.
    \item $x\in[q/2,q[$ and $y\in[0,q/2[$: a similar argument shows that this
      case cannot occur whenever $r(x)=r(y)$.
    \item $x\in[q/2,q[$ and $y\in[q/2,q[$: then $r(x)=x^{*}-q$ and 
      $r(y)=y^{*}-q$ and the equality $r(x)=r(y)$ yields $x^{*}=y^{*}$ as 
      requested.
  \end{enumerate}
We now show that $r$ is surjective. So let $n$ be an integer in $[-q/2,q/2[$.
  We need to show the existence of $x\in\zq$ such that $n=r(x)$. Define $x$
  simply to be the class of $n$ modulo $q$. We need to check that $r(x)=n$. 
  Consider two cases:
  \begin{enumerate}
    \item $n\in[-q/2,0[$: then $n+q\in[q/2,q[$. Hence we see that $n+q\in[0,q[$
      while being equal to $x$ modulo $q$. It follows that $x^{*}=n+q\in[q/2,q[$
      from which we obtain $r(x) = x^{*} - q = n$ as requested.
    \item $n\in[0,q/2[$: then $n\in[0,q[$ while being equal to $x$ modulo $q$.
      It follows that $x^{*}=n\in[0,q/2[$ from which we obtain $r(x)=x^{*}=n$
      as requested.
  \end{enumerate}
\end{proof}

Hence we see that the {\em representable} integers belonging to $[-q/2,q/2[$
are in fact the range of the two's complement representation mapping
$r:\zq\rightarrow\Z$. If $r(x)$ and $r(y)$ are two {\em representable} 
integers, the fundamental question for us is whether $x+y$ is a 
representation of the sum $r(x)+r(y)$. As it turns out, the answer is once 
again 'yes' provided of course that $r(x)+r(y)$ is {\em representable}. 
This result may be regarded as somewhat of a miracle: despite its relative
complexity, the two's complement representation allows us to compute 
the sum $r(x)+r(y)\in\Z$ simply by 
performing the standard operation $x+y\in\zq$. 
\begin{prop}\label{carry:signed:add:morphism}
  For all $x,y\in\zq$, the following are equivalent:
    \begin{eqnarray*}
      (i)&\ &r(x)+r(y)\in[-q/2,q/2[\\
      (ii)&\ &r(x+y)=r(x)+r(y)
    \end{eqnarray*}
\end{prop}
\begin{proof}
  The implication $(ii)\Rightarrow(i)$ is clear. It remains to show 
  $(i)\Rightarrow(ii)$, for which we shall consider four different cases:
  \begin{enumerate}
    \item $x\in[0,q/2[$ and $y\in[0,q/2[$: in this case we have $r(x)=x^{*}$
      and $r(y)=y^{*}$ and condition $(i)$ reduces to $x^{*}+y^{*}\in[-q/2,q/2[$
      which in fact is equivalent to $x^{*}+y^{*}\in[0,q/2[$ (since $x^{*}+y^{*}$
      is never negative). So if $(i)$ is true, we see that $x^{*}+y^{*}\in[0,q[$
      while being equal to $x+y$ modulo $q$, which in turn implies that 
      $(x+y)^{*}=x^{*}+y^{*}\in[0,q/2[$ from which we obtain 
      $r(x+y)=(x+y)^{*}=x^{*}+y^{*}=r(x)+r(y)$ which is condition $(ii)$. 
    \item $x\in[0,q/2[$ and $y\in[q/2,q[$: in this case we have $r(x)=x^{*}$
      as well as $r(y)=y^{*}-q$ and condition $(i)$ reduces to 
      $x^{*}+y^{*}-q\in[-q/2,q/2[$ or equivalently $x^{*}+y^{*}\in[q/2,3q/2[$
      which is always true in this case (since $x^{*}\in[0,q/2[$ and 
      $y^{*}\in[q/2,q[$). So we simply need to prove the equation 
      $r(x+y)=r(x)+r(y)$ for which we shall consider two further cases: 
      First we assume that $x^{*}+y^{*}-q\in[-q/2,0[$. Then we see that 
      $x^{*}+y^{*}\in[q/2,q[$ while being equal to $x+y$ modulo $q$. 
      So $(x+y)^{*}=x^{*}+y^{*}\in[q/2,q[$ and consequently 
      $r(x+y)= (x+y)^{*}-q=x^{*}+y^{*}-q = r(x)+r(y)$ as requested.
      We now assume that $x^{*}+y^{*}-q\in[0,q/2[$. Since it is also equal
      to $x+y$ modulo $q$ we obtain $(x+y)^{*}=x^{*}+y^{*}-q\in[0,q/2[$.
      It follows that $r(x+y)=(x+y)^{*}=x^{*}+y^{*}-q = r(x)+r(y)$ as 
      requested.
    \item $x\in[q/2,q[$ and $y\in[0,q/2[$: addition being commutative
      in \Z\ and \zq, we can conclude that $r(x+y)=r(x)+r(y)$ from
      the previous case.
    \item $x\in[q/2,q[$ and $y\in[q/2,q[$: in this case we have $r(x)=x^{*}-q$
      and $r(y)=y^{*}-q$ and condition $(i)$ reduces to 
      $x^{*}+y^{*}-2q\in[-q/2,q/2[$ which is $x^{*}+y^{*}-q\in[q/2,3q/2[$
      which is in fact equivalent to $x^{*}+y^{*}-q\in[q/2,q[$ (since 
      $x^{*}\in[q/2,q[$ and $y^{*}\in[q/2,q[$). Hence we see that $(i)$ 
      implies $x^{*}+y^{*}-q\in[q/2,q[$ while being equal to $x+y$ modulo
      $q$. It follows that $(x+y)^{*}=x^{*}+y^{*}-q\in[q/2,q[$ and
      consequently we obtain the equation 
      $r(x+y) = (x+y)^{*}-q=x^{*}+y^{*}-2q=r(x)+r(y)$ as requested.
  \end{enumerate}
\end{proof}

As we can see from propostion~(\ref{carry:signed:add:morphism}) there 
may be cases where $x+y\in\zq$ fails to be a representation of the sum
$r(x)+r(y)\in\Z$. The condition under which this anomaly arises is 
called an {\em overflow} rather than {\em carry}:

\begin{defin}\label{carry:signed:add:overflow}
We call {\em overflow for addition} the map $o:\zq\!\times\!\zq\rightarrow2$ defined by:
  \[
    o(x,y) = 1  \ \ \Leftrightarrow\ \ r(x)+r(y)\not\in[-q/2,q/2[
  \]
\end{defin}

As before, this definition is not terribly useful, unless we have some way
of determining when an overflow situation arises:

\begin{prop}\label{carry:signed:add:criterium}
  For all $x,y\in\zq$, we have $o(x,y)=1$ \ifand:
  \[
    x\in[0,q/2[\mbox{\ and\ }y\in[0,q/2[\mbox{\ and\ }x+y\in[q/2,q[
  \]
or:
  \[
    x\in[q/2,q[\mbox{\ and\ }y\in[q/2,q[\mbox{\ and\ }x+y\in[0,q[
  \]
where $o:\zq\times\zq\rightarrow 2$ is the overflow for addition of 
  definition~(\ref{carry:signed:add:overflow}).
\end{prop}
\begin{proof}
  First we assume that $x\in[0,q/2[$, $y\in[0,q/2[$ and $x+y\in[q/2,q[$, and 
  we need to show that $o(x,y)=1$ or equivalently $r(x)+r(y)\not\in[-q/2,q/2[$.
  However in this case, we have $r(x)=x^{*}$ and $r(y)=y^{*}$ and 
  $x^{*}+y^{*}\in[0,q[$ (since $x^{*}\in[0,q/2[$ and $y^{*}\in[0,q/2[$).
  Since $x^{*}+y^{*}$ is equal to $x+y$ modulo $q$ we obtain
  $(x+y)^{*}=x^{*}+y^{*}$ and the assumption $x+y\in[q/2,q[$ therefore
  yields $x^{*}+y^{*}\in[q/2,q[$ which is $r(x)+r(y)\in[q/2,q[$. So we see
  that $r(x)+r(y)$ does not belong to $[-q/2,q/2[$ as requested.

  Next we assume that $x\in[q/2,q[$, $y\in[q/2,q[$ and $x+y\in[0,q/2[$,
  and we need to show that $o(x,y)=1$ or equivalently 
  $r(x)+r(y)\not\in[-q/2,q/2[$. However in this case, we have $r(x)=x^{*}-q$
  and $r(y)=y^{*}-q$ and $x^{*}+y^{*}-q\in[0,q[$ (since $x^{*}\in[q/2,q[$
  and $y^{*}\in[q/2,q[$). Since $x^{*}+y^{*}-q$ is equal to $x+y$ modulo $q$
  we obtain $(x+y)^{*}=x^{*}+y^{*}-q$ and the assumption $x+y\in[0,q/2[$
  therefore yields $x^{*}+y^{*}-q\in[0,q/2[$ which is $r(x)+r(y)\in[-q,-q/2[$.
  So we see that $r(x)+r(y)$ does not belong to $[-q/2,q/2[$ as requested.

  Conversely we assume $o(x,y)=1$ or equivalently 
  $r(x)+r(y)\not\in[-q/2,q/2[$ and we need to show that one of
  the two propeties of proposition~(\ref{carry:signed:add:criterium})
  is satisfied. We shall distinguish four cases:
  \begin{enumerate}
    \item $x\in[0,q/2[$ and $y\in[0,q/2[$: in this case, we only
      need to prove that $x+y\in[q/2,q[$ in order to prove the first 
      property of proposition~(\ref{carry:signed:add:criterium}).
      However, in this case we have $r(x)=x^{*}$ and $r(y)=y^{*}$
      and the condition $o(x,y)=1$ reduces to $x^{*}+y^{*}\not\in[-q/2,q/2[$
      which is equivalent to the condition $x^{*}+y^{*}\not\in[0,q/2[$ 
      (since $x^{*}+y^{*}$  cannot be negative). However we know that 
      $x^{*}+y^{*}\in[0,q[$ (since $x^{*}\in[0,q/2[$ and $y^{*}\in[0,q/2[$) 
      and it follows that $x^{*}+y^{*}\in[q/2,q[$. Furthermore, since 
      $x^{*}+y^{*}$ is equal to $x+y$ modulo $q$, we see that 
      $(x+y)^{*}=x^{*}+y^{*}$ and consequently $(x+y)^{*}\in[q/2,q[$ 
      which is $x+y\in[q/2,q[$ as requested.
    \item $x\in[0,q/2[$ and $y\in[q/2,q[$: in this case we have $r(x)=x^{*}$
      as well as $r(y)=y^{*}-q$ and the condition $o(x,y)=1$ reduces to the
      condition $x^{*}+y^{*}-q\not\in[-q/2,q/2[$ which cannot happen (since
      $x^{*}\in[0,q/2[$ and $y^{*}\in[q/2,q[$). So this case can 
      never happen when $o(x,y)=1$ and there is nothing further to 
      prove.
    \item $x\in[q/2,q[$ and $y\in[0,q/2[$: likewise, having made the
      assumption $o(x,y)=1$ this case can never happen and there is 
      nothing to prove.
    \item $x\in[q/2,q[$ and $y\in[q/2,q[$: in this case, we only 
      need to prove that $x+y\in[0,q/2[$ in order to prove the 
      second property of proposition~(\ref{carry:signed:add:criterium}). 
      However, in this case we have $r(x)=x^{*}-q$ and $r(y)=y^{*}-q$
      and the condition $o(x,y)=1$ reduces to 
      $x^{*}+y^{*}-2q\not\in[-q/2,q/2[$ which is $x^{*}+y^{*}-q\not\in
      [q/2,3q/2[$, which is equivalent to $x^{*}+y^{*}-q\not\in[q/2,q[$
      (since $x^{*}\in[q/2,q[$ and $y^{*}\in[q/2,q[$ and $x^{*}+y^{*}-q$
      belongs to $[0,q[$ anyway). Hence, having assumed that $o(x,y)=1$
      we see that $x^{*}+y^{*}-q\in[0,q/2[$. Furthermore, since
      $x^{*}+y^{*}-q$ is equal to $x+y$ modulo $q$, we obtain
      $(x+y)^{*}=x^{*}+y^{*}-q$ and consequently $(x+y)^{*}\in[0,q/2[$
      which is $x+y\in[0,q/2[$ as requested.
  \end{enumerate}
\end{proof}

For all $x\in\zq$, we have $r(x)=x^{*}\geq 0$ when $x\in[0,q/2[$ 
and furthermore $r(x)=x^{*}-q < 0$ when $x\in[q/2,q[$. So $x$ represents a 
non-negative integer when $x\in[0,q/2[$ and it represents a 
negative integer when $x\in[q/2,q[$. If we think of the binary
representation of $x\in\zq$, it is easy to see that the condition
$x\in[0,q/2[$ corresponds to the highest order bit being cleared,
while $x\in[q/2,q[$ corresponds to the highest order bit being set.
This explains why the highest order bit is commonly called 
the {\em sign bit}. For this reason we define:

\begin{defin}\label{carry:sign:bit}
  We call {\em sign bit mapping} the map $s:\zq\rightarrow 2$ defined by:
    \[
      s(x) = 1\ \Leftrightarrow\ x\in[q/2,q[
    \]
\end{defin}

In the light of definition~(\ref{carry:sign:bit}) we can rephrase 
proposition~(\ref{carry:signed:add:criterium}) as follows:
\begin{prop}\label{carry:signed:add:criterium:2}
  For all $x,y\in\zq$, we have $o(x,y)=1$ \ifand:
  \[
    s(x)=0\mbox{\ and\ }s(y)=0\mbox{\ and\ }s(x+y)=1
  \]
or:
  \[
    s(x)=1\mbox{\ and\ }s(y)=1\mbox{\ and\ }s(x+y)=0
  \]
where $o:\zq\times\zq\rightarrow 2$ is the overflow for addition of 
  definition~(\ref{carry:signed:add:overflow}), while the map 
  $s:\zq\rightarrow 2$ is the sign bit mapping of 
  definition~(\ref{carry:sign:bit}).
\end{prop}
\begin{proof}
  Follows immediately from proposition~(\ref{carry:signed:add:criterium})
  and definition~(\ref{carry:sign:bit}).
\end{proof}

\section{Overflow for subtraction}
Here we are now asking ourselves the same question again: when does the
native CPU operation on \zq\ yield a representation of the result from
the corresponding operation on \Z\,? As before, as long as the result 
from the operation on \Z\ is {\em representable}, the native CPU operation 
on \zq\ provides a representation of it. Given two {\em representable}
integers $r(x)$ and $r(y)$ such that $r(x)-r(y)$ is itself 
{\em representable}, the equation $r(x-y)=r(x)-r(y)$ fundamentally says:
$x-y\in\zq$ is a representation
(in computer hardware) of the difference $r(x)-r(y)\in\Z$. 


\begin{prop}\label{carry:signed:sub:morphism}
  For all $x,y\in\zq$, the following are equivalent:
    \begin{eqnarray*}
      (i)&\ &r(x)-r(y)\in[-q/2,q/2[\\
      (ii)&\ &r(x-y)=r(x)-r(y)
    \end{eqnarray*}
\end{prop}
\begin{proof}
  The implication $(ii)\Rightarrow(i)$ is clear, so we only need to prove
  $(i)\Rightarrow(ii)$. So we assume that $r(x)-r(y)\in[-q/2,q/2[$ and
  we need to show the equality $r(x-y)=r(x)-r(y)$. We shall distinguish
  four cases:
  \begin{enumerate}
    \item $x\in[0,q/2[$ and $y\in[0,q/2[$: in this case we have $r(x)=x^{*}$
      and $r(y)=y^{*}$ and our assumption reduces to $x^{*}-y^{*}\in[-q/2,q/2[$
      which is necessarily true in this case (there is no need to assume it)
      since $x^{*}\in[0,q/2[$ and $y^{*}\in[0,q/2[$ implies 
      $x^{*}-y^{*}\in]-q/2, q/2[$. So we need to prove that 
      $r(x-y)=x^{*}-y^{*}$. We shall distinguish two further cases:
      first we assume that $x^{*}-y^{*}\in]-q/2,0[$. Then $x^{*}-y^{*}+q$
      belongs to $]q/2,q[$ while being equal to $x-y$ modulo $q$.
      It follows that $(x-y)^{*}=x^{*}-y^{*}+q\in]q/2,q[$ and
      consequently $r(x-y) = (x-y)^{*} - q = x^{*}-y^{*}=r(x)-r(y)$
      as requested. We now assume that $x^{*}-y^{*}\in[0,q/2[$. In 
      this case we obtain $(x-y)^{*}=x^{*}-y^{*}\in[0,q/2[$ and
      consequently we have the equation 
      $r(x-y)=(x-y)^{*}=x^{*}-y^{*}=r(x)-r(y)$ as requested.
    \item $x\in[0,q/2[$ and $y\in[q/2,q[$: in this case we have $r(x)=x^{*}$
      as well as $r(y)=y^{*}-q$ and our assumption reduces to 
      $x^{*}-y^{*}+q\in[-q/2,q/2[$, while we need to prove that 
      $r(x-y)=x^{*}-y^{*}+q$. However from $x^{*}\in[0,q/2[$ and 
      $y^{*}\in[q/2,q[$ we obtain $x^{*}-y^{*}\in]-q,0[$ which is
      $x^{*}-y^{*}+q\in]0,q[$. It follows that $x^{*}-y^{*}+q\in]0,q/2[$
      while being equal to $x-y$ modulo $q$. Hence we see that 
      $(x-y)^{*}=x^{*}-y^{*}+q\in]0,q/2[$ and consequently 
      $r(x-y) = (x-y)^{*}=x^{*}-y^{*}+q$ as requested.
    \item $x\in[q/2,q[$ and $y\in[0,q/2[$: in this case we have 
      $r(x)=x^{*}-q$ and $r(y)=y^{*}$ and our assumption reduces to
      $x^{*}-y^{*}-q\in[-q/2,q/2[$ which is $x^{*}-y^{*}\in[q/2,3q/2[$, 
      while we need to prove that $r(x-y)=x^{*}-y^{*}-q$. 
      However from $x^{*}\in[q/2,q[$ and $y^{*}\in[0,q/2[$ we obtain 
      $x^{*}-y^{*}\in]0,q[$. It follows that $x^{*}-y^{*}\in[q/2,q[$
      while being equal to $x-y$ modulo $q$. Hence we see that 
      $(x-y)^{*}=x^{*}-y^{*}\in[q/2,q[$ and consequently we have
      $r(x-y)=(x-y)^{*}-q=x^{*}-y^{*}-q$ as requested.
    \item $x\in[q/2,q[$ and $y\in[q/2,q[$: in this case we have 
      $r(x)=x^{*}-q$ as well as $r(y)=y^{*}-q$ and our assumption reduces to
      $x^{*}-y^{*}\in[-q/2,q/2[$, while we need to prove that 
      $r(x-y)=x^{*}-y^{*}$. However, from $x^{*}\in[q/2,q[$ and 
      $y^{*}\in[q/2,q[$ we obtain $x^{*}-y^{*}\in]-q/2,q/2[$ so our
      assumption is always true in this case (there is no need to 
      assume it). We shall distinguish two further cases: first 
      we assume that $x^{*}-y^{*}\in]-q/2,0[$. Then $x^{*}-y^{*}+q\in]q/2,q[$
      while being equal to $x-y$ modulo $q$. It follows that we have 
      $(x-y)^{*}= x^{*}-y^{*}+q\in]q/2,q[$ and consequently we conclude
      $r(x-y)=(x-y)^{*}-q=x^{*}-y^{*}$ as requested. We now assume that
      $x^{*}-y^{*}\in[0,q/2[$. Then $(x-y)^{*}=x^{*}-y^{*}\in[0,q/2[$ and
      consequently $r(x-y)=(x-y)^{*}=x^{*}-y^{*}$ as requested.
  \end{enumerate}
\end{proof}
In the light of proposition~(\ref{carry:signed:sub:morphism}) we now define:
\begin{defin}\label{carry:signed:sub:overflow}
We call {\em overflow for subtraction} the map 
$o\!:\!\zq\!\!\times\!\!\zq\!\rightarrow\!2\!$ defined by:
  \[
    o(x,y) = 1  \ \ \Leftrightarrow\ \ r(x)-r(y)\not\in[-q/2,q/2[
  \]
\end{defin}
Similarly to proposition~(\ref{carry:signed:add:criterium}) we now 
characterize the overflow for subtraction:
\begin{prop}\label{carry:signed:sub:criterium}
  For all $x,y\in\zq$, we have $o(x,y)=1$ \ifand:
  \[
    x\in[0,q/2[\mbox{\ and\ }y\in[q/2,q[\mbox{\ and\ }x-y\in[q/2,q[
  \]
or:
  \[
    x\in[q/2,q[\mbox{\ and\ }y\in[0,q/2[\mbox{\ and\ }x-y\in[0,q[
  \]
where $o:\zq\times\zq\rightarrow 2$ is the overflow for subtraction of 
  definition~(\ref{carry:signed:add:overflow}).
\end{prop}
\begin{proof}
  First we assume that $x\in[0,q/2[$, $y\in[q/2,q[$ and $x-y\in[q/2,q[$, and 
  we need to show that $o(x,y)=1$ or equivalently $r(x)-r(y)\not\in[-q/2,q/2[$.
  However in this case, we have $r(x)=x^{*}$ and $r(y)=y^{*}-q$ and 
  $x^{*}-y^{*}+q\in]0,q[$ (since $x^{*}\in[0,q/2[$ and $y^{*}\in[q/2,q[$).
  Since $x^{*}-y^{*}+q$ is equal to $x-y$ modulo $q$ we obtain
  $(x-y)^{*}=x^{*}-y^{*}+q$ and the assumption $x-y\in[q/2,q[$ therefore
  yields $x^{*}-y^{*}+q\in[q/2,q[$ which is $r(x)-r(y)\in[q/2,q[$. So we see
  that $r(x)-r(y)$ does not belong to $[-q/2,q/2[$ as requested.

  Next we assume that $x\in[q/2,q[$, $y\in[0,q/2[$ and $x-y\in[0,q/2[$,
  and we need to show that $o(x,y)=1$ or equivalently 
  $r(x)-r(y)\not\in[-q/2,q/2[$. However in this case, we have $r(x)=x^{*}-q$
  and $r(y)=y^{*}$ and $x^{*}-y^{*}\in]0,q[$ (since $x^{*}\in[q/2,q[$
  and $y^{*}\in[0,q/2[$). Since $x^{*}-y^{*}$ is equal to $x-y$ modulo $q$
  we obtain $(x-y)^{*}=x^{*}-y^{*}$ and the assumption $x-y\in[0,q/2[$
  therefore yields $x^{*}-y^{*}\in[0,q/2[$ which is $r(x)-r(y)\in[-q,-q/2[$.
  So we see that $r(x)-r(y)$ does not belong to $[-q/2,q/2[$ as requested.

  Conversely we assume $o(x,y)=1$ or equivalently
  $r(x)-r(y)\not\in[-q/2,q/2[$ and we need to show that one of
  the two propeties of proposition~(\ref{carry:signed:sub:criterium})
  is satisfied. We shall distinguish four cases:
  \begin{enumerate}
    \item $x\in[0,q/2[$ and $y\in[0,q/2[$: in this case we have $r(x)=x^{*}$
      and $r(y)=y^{*}$ and the condition $o(x,y)=1$ reduces to
      $x^{*}-y^{*}\not\in[-q/2,q/2[$ which cannot happen (since
      $x^{*}\in[0,q/2[$ and $y^{*}\in[0,q/2[$). So this case can 
      never happen when $o(x,y)=1$ and there is nothing further to 
      prove.
     \item $x\in[0,q/2[$ and $y\in[q/2,q[$: in this case, we only
      need to prove that $x-y\in[q/2,q[$ in order to prove the first 
      property of proposition~(\ref{carry:signed:sub:criterium}).
      However, in this case we have $r(x)=x^{*}$ and $r(y)=y^{*}-q$
      and the condition $o(x,y)=1$ reduces to 
      $x^{*}-y^{*}+q\not\in[-q/2,q/2[$. However we know that 
      $x^{*}-y^{*}+q\in]0,q[$ 
      (since $x^{*}\in[0,q/2[$ and $y^{*}\in[q/2,q[$) and it follows
      that $x^{*}-y^{*}+q\in[q/2,q[$. Furthermore, since $x^{*}-y^{*}+q$ is
      equal to $x-y$ modulo $q$, we see that $(x-y)^{*}=x^{*}-y^{*}+q$
      and consequently $(x-y)^{*}\in[q/2,q[$ which is $x-y\in[q/2,q[$
      as requested.
   \item $x\in[q/2,q[$ and $y\in[0,q/2[$: in this case, we only 
      need to prove that $x-y\in[0,q/2[$ in order to prove the 
      second property of proposition~(\ref{carry:signed:sub:criterium}). 
      However, in this case we have $r(x)=x^{*}-q$ and $r(y)=y^{*}$
      and the condition $o(x,y)=1$ reduces to 
      $x^{*}-y^{*}-q\not\in[-q/2,q/2[$ or equivalently $x^{*}-y^{*}\not\in
      [q/2,3q/2[$. However, we know that $x^{*}-y^{*}\in]0,q[$
      (from the conditions $x^{*}\in[q/2,q[$ and $y^{*}\in[0,q/2[$). 
      Hence, having assumed that $o(x,y)=1$ we see that 
      $x^{*}-y^{*}\in]0,q/2[$. Furthermore, since
      $x^{*}-y^{*}$ is equal to $x-y$ modulo $q$, we obtain
      $(x-y)^{*}=x^{*}-y^{*}$ and consequently $(x-y)^{*}\in]0,q/2[$
      which is $x-y\in]0,q/2[\subseteq[0,q/2[$ as requested.
   \item $x\in[q/2,q[$ and $y\in[q/2,q[$: in this case we have
     $r(x)=x^{*}-q$ and $r(y)=y^{*}-q$ and the condition $o(x,y)=1$
      reduces to $x^{*}-y^{*}\not\in[-q/2,q/2[$ which cannot happen
      (since $x^{*}\in[q/2,q[$ and $y^{*}\in[q/2,q[$). So this case can
      never happen when $o(x,y)=1$ and there is nothing further to prove.
   \end{enumerate}
\end{proof}

Proposition~(\ref{carry:signed:sub:criterium}) can equivalently be expressed
in terms of sign bits.
\begin{prop}\label{carry:signed:sub:criterium:2}
  For all $x,y\in\zq$, we have $o(x,y)=1$ \ifand:
  \[
    s(x)=0\mbox{\ and\ }s(y)=1\mbox{\ and\ }s(x-y)=1
  \]
or:
  \[
    s(x)=1\mbox{\ and\ }s(y)=0\mbox{\ and\ }s(x-y)=0
  \]
where $o:\zq\times\zq\rightarrow 2$ is the overflow for subtraction of 
  definition~(\ref{carry:signed:sub:overflow}), while the map $s:\zq\rightarrow 2$
  is the sign bit mapping of definition~(\ref{carry:sign:bit}).
\end{prop}
\begin{proof}
  Follows immediately from proposition~(\ref{carry:signed:sub:criterium})
  and definition~(\ref{carry:sign:bit}).
\end{proof}

\section{Unsigned Comparison}
Users of computer hardware are not interested in \zq. What holds true
for operations is equally true for comparisons: given $x,y\in\zq$, what
matters is not so much whether $x<y$, but rather whether $x^{*}<y^{*}$.
We care about natural numbers and their properties, not what may or
may not be true of their representation in \zq. As it turns out, there
is no difference between $x<y$ and $x^{*}<y^{*}$ as we artificially
defined the order on \zq\ so that the two notions coincide. Furthermore,
from definition~(\ref{carry:unsigned:sub:carry}) the condition 
$x^{*}<y^{*}$ is precisely the condition $c(x,y)=1$ where $c$ is 
the {\em carry for subtraction}. This carry is a fundamental primitive
of computer hardware, allowing users to be warned of situation where
$x-y$ is no longer a representation of $x^{*}-y^{*}$. Hence typically,
whenever the assembly instruction '{\rm cmp x,y}' (or '{\rm sub x,y}')
is executed, the carry flag will be set or cleared, depending on whether
$x<y$ or not. Using this carry flag, we are able to test the conditions.
$x<y$ and $x\geq y$. In order to test for $x>y$ and $x\leq y$, we
either use '{\rm cmp y, x'}' rather than '{\rm cmp x,y}', or we need
to also test for equality. For completeness, we now define:

\begin{defin}\label{carry:zero:bit}
  We call {\em zero bit mapping} the map $z:\zq\rightarrow 2$ defined by:
    \[
      z(x) = 1\ \Leftrightarrow\ x=0
    \]
\end{defin}

The {\em zero bit mapping} is typically implemented as a flag which is set
or cleared depending on whether $z(x)=1$ or $z(x)=0$, where $x\in\zq$ is 
a quantity (often the result) relevant to the last executed CPU instruction. 
We now state:

\begin{prop}\label{carry:unsigned:comparison}
  Let $c:\zq\times\zq\rightarrow 2$ and $z:\zq\rightarrow 2$ be the {\em carry 
  for subtraction} and {\em zero bit mapping} as defined 
  in definitions~(\ref{carry:unsigned:sub:carry} and~(\ref{carry:zero:bit}) 
  respectively. Then for all $x,y\in\zq$ we have the following equivalences:
    \begin{eqnarray*}
      x^{*} = y^{*}&\Leftrightarrow&z(x-y)=1\\ 
      x^{*}\neq y^{*}&\Leftrightarrow&z(x-y)=0\\
      x^{*} < y^{*}&\Leftrightarrow&c(x,y)=1\\
      x^{*}\leq y^{*}&\Leftrightarrow&c(x,y)=1\lor z(x-y)=1\\
      x^{*}\geq y^{*}&\Leftrightarrow &c(x,y)=0\\
      x^{*}>y^{*}&\Leftrightarrow& c(x,y)=0 \land z(x-y)=0
    \end{eqnarray*}
\end{prop}
\begin{proof}
  From definition~(\ref{carry:zero:bit}) the equality $z(x-y)=1$ is equivalent
  to $x-y=0$ which is $x=y$. This is in turn equivalent to $x^{*}=y^{*}$ since
  $x\rightarrow x^{*}$ is a bijection from $\zq$ to $\N\cap[0,q[$. The 
  equivalence between $x^{*}<y^{*}$ and $c(x,y)=1$ is true from the very
  definition (definition~(\ref{carry:unsigned:sub:carry})) of {\em carry
  for subtraction}. Every other equivalence of 
  proposition~(\ref{carry:unsigned:comparison}) follow from simple logic.
\end{proof}

\section{Signed Comparison}
If $r(x)$ and $r(y)$ are two representable integers, while the ability 
to compute their sum and difference is paramount, it is often just as 
important to compare these numbers. As already suggested in the unsigned
case, the conditions $r(x)<r(y)$ and $x<y$ are in principle two very
different things. In fact, as we now know, $x<y$ is a condition based
on carry for subtraction, while $r(x)<r(y)$ has
little to do with carry at all, as can be seen from this next proposition:

\begin{prop}\label{carry:signed:comparison}
  Let $o:\zq\times\zq\rightarrow 2$, $s:\zq\rightarrow 2$ and 
  $z:\zq\rightarrow 2$ be the {\em overflow for subtraction}, the
  {\em sign bit mapping} and the {\em zero bit mapping} as defined 
  in definitions~(\ref{carry:signed:sub:overflow}, 
  (\ref{carry:sign:bit}) and~(\ref{carry:zero:bit}) 
  respectively. Then for all $x,y\in\zq$ we have:
    \begin{eqnarray*}
      r(x) = r(y)&\Leftrightarrow&z(x-y)=1\\ 
      r(x)\neq r(y)&\Leftrightarrow&z(x-y)=0\\
      r(x) < r(y)&\Leftrightarrow&o(x,y)\neq s(x-y)\\
      r(x)\leq r(y)&\Leftrightarrow&o(x,y)\neq s(x-y)\lor z(x-y)=1\\
      r(x)\geq r(y)&\Leftrightarrow &o(x,y)=s(x-y)\\
      r(x)>r(y)&\Leftrightarrow&o(x,y)=s(x-y) \land z(x-y)=0
    \end{eqnarray*}
  where $r:\zq\rightarrow\Z\cap[-q/2,q/2[$ is the {\em two's complement
  representation} of~(\ref{carry:signed:2:complement}).
\end{prop}
\begin{proof}
  From definition~(\ref{carry:zero:bit}) the equality $z(x-y)=1$ is equivalent
  to $x-y=0$ which is $x=y$. This is in turn equivalent to $r(x)=r(y)$ since
  $r$ is a bijection from $\zq$ to $\Z\cap[-q/2,q/2[$. Every other equivalence
  follows from elementary logic, once we have proven that $r(x)<r(x)$ is
  equivalent to $o(x,y)\neq s(x-y)$ which we shall do now. So first we 
  assume that $r(x)<r(y)$ and we need to show that $o(x,y)\neq s(x-y)$.
  We shall distinguish four cases:
  \begin{enumerate}
    \item $x\in[0,q/2[$ and $y\in[0,q/2[$: in this case, from 
      proposition~(\ref{carry:signed:sub:criterium}) the overflow for
      subtraction has to be $o(x,y)=0$ and we therefore need to prove
      that $s(x-y)=1$ or equivalently that $x-y\in[q/2,q[$. Furthermore,
      in this case the assumption $r(x)<r(y)$ becomes $x^{*}<y^{*}$.
      However, we know that $x^{*}-y^{*}\in]-q/2,q/2[$ (since 
      $x^{*}\in[0,q/2[$ and $y^{*}\in[0,q/2[$). It follows that
      $x^{*}-y^{*}\in]-q/2,0[$ which is $x^{*}-y^{*}+q\in]q/2,q[$
      while being equal to $x-y$ modulo $q$. Hence we see that
      $(x-y)^{*}=x^{*}-y^{*}+q\in]q/2,q[$ which implies that
      $x-y\in]q/2,q[\subseteq[q/2,q[$ as requested.
    \item $x\in[0,q/2[$ and $y\in[q/2,q[$: in this case the assumption 
      $r(x)<r(y)$ becomes $x^{*}<y^{*}-q$ which leads to the
      contradiction $x^{*}<0$. Hence this case cannot occur 
      when $r(x)<r(y)$ and there is nothing further to prove.
    \item $x\in[q/2,q[$ and $y\in[0,q/2[$: in this case, from
      proposition~(\ref{carry:signed:sub:criterium}) the overflow
      for substraction $o(x,y)$ is equal to $1$ \ifand\ $x-y\in[0,q/2[$.
      However, this is equivalent to $s(x-y)=0$. Hence we see that
      $o(x,y)\neq s(x-y)$ as requested. We did not make use of the 
      assumption $r(x)<r(y)$ in this case, which reduces to 
      $x^{*}-q < y^{*}$ and is always true anyway. 
    \item $x\in[q/2,q[$ and $y\in[q/2,q[$: in this case, from
      proposition~(\ref{carry:signed:sub:criterium}) the overflow for 
      subtraction is $o(x,y)=0$ and we therefore need to prove 
      $s(x-y)=1$ or equivalently that $x-y\in[q/2,q[$. Furthermore,
      in this case the assumption $r(x)<r(y)$ becomes $x^{*}-q<y^{*}-q$
      which is $x^{*}<y^{*}$. However, we know that $x^{*}-y^{*}\in]-q/2,q/2[$
      (since $x^{*}\in[q/2,q[$ and $y^{*}\in[q/2,q[$). It follows that
      $x^{*}-y^{*}\in]-q/2,0[$ which is $x^{*}-y^{*}+q\in]q/2,q[$
      while being equal to $x-y$ modulo $q$. Hence we see that
      $(x-y)^{*}=x^{*}-y^{*}+q\in]q/2,q[$ which implies that
      $x-y\in]q/2,q[\subseteq[q/2,q[$ as requested.
  \end{enumerate}
  Conversely, we asssume that $o(x,y)\neq s(x-y)$ and we need to prove
  that $r(x)<r(y)$. We shall distinguish four cases:
    \begin{enumerate}
      \item $x\in[0,q/2[$ and $y\in[0,q/2[$: in this case, we need to prove 
        that $x^{*}<y^{*}$. However, from 
        proposition~(\ref{carry:signed:sub:criterium}) we have $o(x,y)=0$
        and our assumption $o(x,y)\neq s(x-y)$ therefore reduces to 
        $s(x-y)=1$ which is $x-y\in[q/2,q[$. However, we know that 
        $x^{*}-y^{*}\in]-q/2,q/2[$ (since $x^{*}\in[0,q/2[$ and 
        $y^{*}\in[0,q/2[$) and in order to prove $x^{*}<y^{*}$ it is 
        sufficient to show that $x^{*}-y^{*}\not\in[0,q/2[$. So
        suppose $x^{*}-y^{*}\in[0,q/2[$. We shall reach a contradiction.
        Since it is also equal to $x-y$ modulo $q$, we obtain
        the equation $(x-y)^{*}=x^{*}-y^{*}$  and our assumption 
        $x-y\in[q/2,q[$ now becomes $x^{*}-y^{*}\in[q/2,q[$ which 
        is our desired contradiction.
      \item $x\in[0,q/2[$ and $y\in[q/2,q[$: in this case, from
        proposition~(\ref{carry:signed:sub:criterium}) we see that 
        $o(x,y)=1$ \ifand\ $x-y\in[q/2,q[$ which is $s(x-y)=1$. It 
        follows that $o(x,y)=s(x-y)$ contradicting our assumption
        $o(x,y)\neq s(x-y)$. So this case cannot happen and there 
        is nothing prove.
      \item $x\in[q/2,q[$ and $y\in[0,q/2[$: in this case, we need
        to prove that $x^{*}-q < y^{*}$ which is clear since $x^{*}-q <0$
        while $y^{*}\geq 0$.
      \item $x\in[q/2,q[$ and $y\in[q/2,q[$: in this case, we need to 
        prove $x^{*}-q < y^{*}-q$ which is $x^{*}<y^{*}$. However,
        from proposition~(\ref{carry:signed:sub:criterium}) we have
        $o(x,y)=0$ and our assumption $o(x,y)\neq s(x-y)$ therefore
        reduces to $s(x-y)=1$ which is $x-y\in[q/2,q[$. Now we know
        that $x^{*}-y^{*}\in]-q/2,q/2[$ (since $x^{*}\in[q/2,q[$
        and $y^{*}\in[q/2,q[$). In order to prove that $x^{*}<y^{*}$
        it is sufficient to show that $x^{*}-y^{*}\not\in[0,q/2[$.
        So let us assume that $x^{*}-y^{*}\in[0,q/2[$. We shall
        reach a contradiction. Since it is equal to $x-y$ modulo
        $q$ we obtain $(x-y)^{*}=x^{*}-y^{*}$ and our assumption
        $x-y\in[q/2,q[$ now becomes $x^{*}-y^{*}\in[q/2,q[$ which is
        our desired contradiction.
    \end{enumerate}
\end{proof}


\end{document}
