Suppose we had a parameterized integral $I(x)=\int f(x,y)dy$ defined
for $x\in A$. Given some $a\in A$, we would naturally write
$I(a)=\int f(a,y)dy$. However, if $y$ was also an element of $A$,
very few of us would dare to say $I(y)=\int f(y,y)dy$. Substituting
the variable $y$ in place of $x$ is not valid, or in other words the
substitution $[y/x]$ is not a valid substitution for the formula
$\phi=\int f(x,y)dy$. Similarly, if we had the formula $\phi=\forall
y (x\in y)\in\pv$ with $x\neq y$ which expresses some unary
predicate $I(x)$, it would be a natural thing to write the formula
$I(a)=\forall y(a\in y)$ whenever $a\neq y$, while referring to
$\forall y(y\in y)$ as representing $I(y)$ would make no sense. Here
again it is clear that the substitution $[y/x]$ is not a valid
substitution for the formula $\phi=\forall y(x\in y)$ when $x\neq
y$. It is not clear at this stage how $I(y)$ should be defined but
we certainly know it cannot be defined in terms of a substitution of
variable which is not valid. At some point, it will be important for
us to define $I(y)$ in order to claim that:
    \[
    \forall x\forall y(x\in y)\to I(a)
    \]
is a legitimate axiom, including when $a=y$. We shall worry about
this later. In this section, we want to formally define the notion
of substitution $\sigma:V\to W$ which is valid for a formula
$\phi\in\pv$. We are keeping $W$ as an arbitrary set rather than
$W=V$ to make this discussion as general as possible.

So suppose $\phi=\forall y(x\in y)$ with $x\neq y$ and $\sigma:V\to
W$ is an arbitrary map. Then $\sigma(\phi) = \forall v(u\in v)$
where $u=\sigma(x)$ and $v=\sigma(y)$. The question we are facing is
to determine which conditions should be imposed on $\sigma$ to make
it a valid substitution for $\phi$. Since $x$ is a free variable of
$\forall y(x\in y)$, a natural condition seems to require that $u$
be a free variable of $\forall v(u\in v)$. This can only happen when
$u\neq v$ which leads to the condition $\sigma(x)\neq\sigma(y)$. So
it seems that an injective $\sigma$ would be a valid substitution
for $\phi$. In fact, we know from
proposition~(\ref{logic:prop:substitution:support}) that
$\sigma(\phi)$ only depends on the restriction
$\sigma_{|\var(\phi)}$ so we may require that $\sigma_{|\var(\phi)}$
be injective rather than $\sigma$ itself. However, does injectivity
really matter? Suppose we had $\phi=\forall y[(x\in y)\to (y\in z)]$
with $x,y,z$ distinct. There would be nothing wrong with a
substitution $\sigma$ leading to the formula $\forall v[(u\in
v)\to(v\in u)]$ with $u\neq v$. There is nothing absurd in
considering the binary predicate $I(x,z) =\forall y[(x\in y)\to(y\in
z)]$ with $(x,z)=(u,u)$ (having changed the bound variable $y$ by
$v$). So injectivity does not matter. What matters is the fact that
the free variables $x$ and $z$ of $\phi$ have been substituted by
the free variable $u$ in $\forall v[(u\in v)\to(v\in u)]$. In other
words, when considering a formula $\phi=\forall y[\ \ldots\ x\
\ldots\ z\ \ldots\ ]$ with $x$ and $z$ free, what matters is not to
end up with something like $\sigma(\phi)=\forall \sigma(y)[\ \ldots
\ \sigma(x)\ \ldots\ \sigma(z)\ \ldots\ ]$ with
$\sigma(x)=\sigma(y)$ or $\sigma(z) = \sigma(y)$. We do not want
free variables of $\phi$ to become artificially bound by the
substitution $\sigma$. So it seems that a possible condition for the
substitution $\sigma$ to be valid for $\phi$ is the following:
    \[
    x\in\free(\phi)\ \Rightarrow\ \sigma(x)\in\free(\sigma(\phi))
    \]
So let us consider $\phi=\forall x\forall y(x\in y)$ with $x\neq y$
as a new example. In this case, the formula $\phi$ has no free
variables and there is therefore no risk of having a free variable
getting artificially bound by a substitution $\sigma$. So any
substitution $\sigma$ would seem to be valid for $\phi$, which of
course isn't the case. As a rule of thumb, a valid substitution
$\sigma$ is one which prevents a mathematician writing nonsense. If
$\phi=\forall x\psi$ with $\psi=\forall y(x\in y)$, then we cannot
hope $\sigma(\phi)=\forall \sigma(x)\sigma(\psi)$ to be a legitimate
expression, unless $\sigma(\psi)$ itself is a legitimate expression.
So yes, we do not want free variables to become artificially bound
by the substitution $\sigma$, but these free variables are not so
much the free variables of $\phi$ itself. There are also the free
variables of $\psi$ or more generally of any sub-formula of $\phi$.
So in the light of this discussion we shall attempt the following:
\index{valid@Valid substitution for
formula}\index{capture@Capture-avoiding substitution}
\begin{defin}\label{logic:def:FOPL:valid:substitution}
Let $V$ and $W$ be sets and $\sigma:V\to W$ be a map. Let
$\phi\in\pv$. We say that $\sigma$ is {\em valid for} $\phi$ \ifand\
for every sub-formula $\psi\preceq\phi$ we have:
    \[
    x\in\free(\psi)\ \Rightarrow\ \sigma(x)\in\free(\sigma(\psi))
    \]
where $\sigma:\pv\to{\bf P}(W)$ also denotes the associated
substitution mapping.
\end{defin}
Recall that the notion of sub-formula and the relation
$\psi\preceq\phi$ are defined in
definition~(\ref{logic:def:subformula}) of
page~\pageref{logic:def:subformula}. An immediate consequence of
definition~(\ref{logic:def:FOPL:valid:substitution}) is:
\begin{prop}\label{logic:prop:FOPL:valid:subformula}
Let $V$ and $W$ be sets and $\sigma:V\to W$ be a map. Let
$\phi\in\pv$. Then $\sigma$ is valid for $\phi$ \ifand\ it is valid
for any sub-formula $\psi\preceq\phi$.
\end{prop}
\begin{proof}
Since $\phi\preceq\phi$, i.e. $\phi$ is a sub-formula of itself, the
'if' part of this proposition is clear. So we now prove the 'only
if' part. So suppose $\sigma$ is valid for $\phi$ and let
$\psi\preceq\phi$. We need to show that $\sigma$ is also valid for
$\psi$. So let $\chi\preceq\psi$ and let $x\in\free(\chi)$. We need
to show that $\sigma(x)\in\free(\sigma(\chi))$, which follows
immediately from the validity of $\sigma$ for $\phi$ and the fact
(by transitivity) that $\chi\preceq\phi$, i.e. that $\chi$ is also a
sub-formula of $\phi$.
\end{proof}

Another immediate consequence of
definition~(\ref{logic:def:FOPL:valid:substitution}) is:
\begin{prop}\label{logic:prop:FOPL:valid:free:commute}
Let $V$ and $W$ be sets and $\sigma:V\to W$ be a map. Let
$\phi\in\pv$. Then $\sigma$ is valid for $\phi$ \ifand\ for every
sub-formula $\psi\preceq\phi$ we have:
    \[
    \free(\sigma(\psi)) =\sigma(\free(\psi))
    \]
\end{prop}
\begin{proof}
The substitution $\sigma:V\to W$ if valid for $\phi$ \ifand\ for all
$\psi\preceq\phi$:
    \[
    x\in\free(\psi)\ \Rightarrow\ \sigma(x)\in\free(\sigma(\psi))
    \]
This condition is clearly equivalent to
$\sigma(\free(\psi))\subseteq\free(\sigma(\psi))$, where
$\sigma(\free(\psi))$ refers to the direct image of the set
$\free(\psi)$ by the map $\sigma:V\to W$. From
proposition~(\ref{logic:prop:freevar:of:substitution:inclusion}) we
know the reverse inclusion
$\free(\sigma(\psi))\subseteq\sigma(\free(\psi))$ is always true.
\end{proof}

As anticipated, if $\sigma$ is injective on $\var(\phi)$ then it is
valid for $\phi$:

\begin{prop}\label{logic:prop:FOPL:valid:injective}
Let $V$ and $W$ be sets and $\sigma:V\to W$ be a map. Let
$\phi\in\pv$ such that $\sigma_{|\var(\phi)}$ is an injective map.
Then $\sigma$ is valid for $\phi$.
\end{prop}
\begin{proof}
Let $\sigma:V\to W$ be map and $\phi\in\pv$ such that the
restriction $\sigma_{|\var(\phi)}$ is an injective map. We need to
show that $\sigma$ is valid for $\phi$. So let $\psi\preceq\phi$.
Using proposition~(\ref{logic:prop:FOPL:valid:free:commute}), we
need to show that $\free(\sigma(\psi)) =\sigma(\free(\psi))$. From
proposition~(\ref{logic:prop:freevar:of:substitution}), it is
sufficient to prove that $\sigma_{|\var(\psi)}$ is injective. Since
$\sigma_{|\var(\phi)}$ is injective, it is sufficient to show that
$\var(\psi)\subseteq\var(\phi)$ which follows from $\psi\preceq\phi$
and proposition~(\ref{logic:prop:FOPL:variable:subformula}).
\end{proof}

If it is meaningful to speak of $\sigma(\phi_{1})$ and
$\sigma(\phi_{2})$, it should also be meaningful to consider
$\sigma(\phi_{1})\to\sigma(\phi_{2})$ which is the same as
$\sigma(\phi_{1}\to\phi_{2})$. So in order to prove that a
substitution $\sigma$ is valid for $\phi=\phi_{1}\to\phi_{2}$, it
should be sufficient to establish its validity both for $\phi_{1}$
and $\phi_{2}$. The following proposition establishes that fact,
which may be useful for structural induction arguments on \pv.
\begin{prop}\label{logic:prop:FOPL:valid:recursion:imp}
Let $V$ and $W$ be sets and $\sigma:V\to W$ be a map. Let
$\phi\in\pv$ of the form $\phi=\phi_{1}\to\phi_{2}$ with
$\phi_{1},\phi_{2}\in\pv$. Then $\sigma$ is valid for $\phi$ \ifand\
it is valid for both $\phi_{1}$ and $\phi_{2}$.
\end{prop}
\begin{proof}
Suppose $\sigma$ is valid for $\phi=\phi_{1}\to\phi_{2}$. From the
equality:
    \begin{equation}\label{logic:eq:FOPL:valid:recursion:imp:1}
    \subf(\phi)=\{\phi_{1}\to\phi_{2}\}\cup\subf(\phi_{1})\cup\subf(\phi_{2})
    \end{equation}
we obtain $\phi_{1}\in\subf(\phi_{1})\subseteq\subf(\phi)$ and
$\phi_{2}\in\subf(\phi_{2})\subseteq\subf(\phi)$. Hence we see that
$\phi_{1}\preceq\phi$ and $\phi_{2}\preceq\phi$ i.e. both $\phi_{1}$
and $\phi_{2}$ are sub-formulas of $\phi$. It follows from
proposition~(\ref{logic:prop:FOPL:valid:subformula}) that $\sigma$
is valid for both $\phi_{1}$ and $\phi_{2}$. Conversely, suppose
$\sigma$ is valid for $\phi_{1}$ and $\phi_{2}$. We need to show
that $\sigma$ is valid for $\phi=\phi_{1}\to\phi_{2}$. So let
$\psi\preceq\phi$ and $u\in\free(\psi)$. We need to show that
$\sigma(u)\in\free(\sigma(\psi))$. From $\psi\preceq\phi$ we have
$\psi\in\subf(\phi)$. So from the above
equation~(\ref{logic:eq:FOPL:valid:recursion:imp:1}), we must have
$\psi=\phi$ or $\psi\in\subf(\phi_{1})$ or $\psi\in\subf(\psi_{2})$.
So we shall distinguish three cases: first we assume that
$\psi\in\subf(\phi_{1})$. Then $\psi\preceq\phi_{1}$ and from
$u\in\free(\psi)$ and the validity of $\sigma$ for $\phi_{1}$ we see
that $\sigma(u)\in\free(\sigma(\psi))$. Next we assume that
$\psi\in\subf(\phi_{2})$. Then a similar argument shows that
$\sigma(u)\in\free(\sigma(\psi))$. Finally we assume that
$\psi=\phi$. Then $\free(\psi) = \free(\phi_{1}\to\phi_{2})=
\free(\phi_{1})\cup\free(\phi_{2})$ and from $u\in\free(\psi)$ we
must have $u\in\free(\phi_{1})$ or $u\in\free(\phi_{2})$. So we
shall distinguish two further cases: first we assume that
$u\in\free(\phi_{1})$. From $\phi_{1}\preceq\phi_{1}$ and the
validity of $\sigma$ for $\phi_{1}$ we obtain
$\sigma(u)\in\free(\sigma(\phi_{1}))$. However, we have:
    \begin{eqnarray*}
    \free(\sigma(\phi_{1}))&\subseteq&\free(\sigma(\phi_{1}))\cup\free(\sigma(\phi_{2}))\\
    &=&\free(\sigma(\phi_{1})\to\sigma(\phi_{2}))\\
    &=&\free(\sigma(\phi_{1}\to\phi_{2}))\\
    &=&\free(\sigma(\psi))
    \end{eqnarray*}
Hence we see that $\sigma(u)\in\free(\sigma(\psi))$. Next we assume
that $u\in\free(\phi_{2})$. Then a similar argument shows that
$\sigma(u)\in\free(\sigma(\psi))$. In all possible cases we have
shown that $\sigma(u)\in\free(\sigma(\psi))$.
\end{proof}

The next proposition may also be useful for induction arguments on
\pv. It establishes conditions for a substitution $\sigma$ to be
valid for a formula of the form $\phi=\forall x\phi_{1}$. As
expected, the validity of $\sigma$ for $\phi_{1}$ is a prerequisite.
However, we also require free variables of $\phi$ not to become
artificially bound by the substitution $\sigma$. This naturally
leads to the condition $u\in\free(\phi)\ \Rightarrow\
\sigma(u)\neq\sigma(x)$.

\begin{prop}\label{logic:prop:FOPL:valid:recursion:quant}
Let $V$ and $W$ be sets and $\sigma:V\to W$ be a map. Let
$\phi\in\pv$ of the form $\phi=\forall x\phi_{1}$ with
$\phi_{1}\in\pv$ and $x\in V$. Then $\sigma$ is valid for $\phi$
\ifand\ it is valid for $\phi_{1}$ and for all $u\in V$ we have:
    \[
    u\in\free(\forall x\phi_{1})\ \Rightarrow\
    \sigma(u)\neq\sigma(x)
    \]
\end{prop}
\begin{proof}
First we show the 'only if' part. So suppose $\sigma$ is valid for
$\phi=\forall x\phi_{1}$. From:
    \begin{equation}\label{logic:eq:FOPL:valid:recursion:quant:1}
    \subf(\phi)=\{\forall x\phi_{1}\}\cup\subf(\phi_{1})
    \end{equation}
we obtain $\phi_{1}\in\subf(\phi_{1})\subseteq\subf(\phi)$ and
consequently $\phi_{1}\preceq\phi$ i.e. $\phi_{1}$ is a sub-formula
of $\phi$. It follows from
proposition~(\ref{logic:prop:FOPL:valid:subformula}) that $\sigma$
is valid for $\phi_{1}$. So let $u\in\free(\forall
x\phi_{1})=\free(\phi)$. It remains to show that
$\sigma(u)\neq\sigma(x)$. Since $\phi\preceq\phi$ and
$u\in\free(\phi)$ it follows from the validity of $\sigma$ for
$\phi$ that $\sigma(u)\in\free(\sigma(\phi))$. Hence $\sigma(u)$ is
a free variable of $\sigma(\phi)=\forall\sigma(x)\sigma(\phi_{1})$,
so $\sigma(u)\neq\sigma(x)$ as requested.

We now prove the 'if' part. So suppose $\sigma$ is valid for
$\phi_{1}$ and furthermore that $\sigma(u)\neq\sigma(x)$ whenever
$u\in\free(\forall x\phi_{1})=\free(\phi)$. We need to show that
$\sigma$ is valid for $\phi=\forall x\phi_{1}$. So let
$\psi\preceq\phi$ and $u\in\free(\psi)$. We need to show that
$\sigma(u)\in\free(\sigma(\psi))$. From $\psi\preceq\phi$ we have
$\psi\in\subf(\phi)$. So from the above
equation~(\ref{logic:eq:FOPL:valid:recursion:quant:1}), we must have
$\psi=\phi$ or $\psi\in\subf(\phi_{1})$. So we shall distinguish two
cases: first we assume that $\psi\in\subf(\phi_{1})$. Then
$\psi\preceq\phi_{1}$ and from $u\in\free(\psi)$ and the validity of
$\sigma$ for $\phi_{1}$ we see that
$\sigma(u)\in\free(\sigma(\psi))$. Next we assume that $\psi=\phi$.
Then $\free(\psi) = \free(\forall x\phi_{1})=
\free(\phi_{1})\setminus\{x\}$ and from $u\in\free(\psi)$ we must
have in particular $u\in\free(\phi_{1})$. From
$\phi_{1}\preceq\phi_{1}$ and the validity of $\sigma$ for
$\phi_{1}$ we obtain $\sigma(u)\in\free(\sigma(\phi_{1}))$.
Furthermore, from $u\in\free(\psi)$ and $\psi=\phi$ we obtain
$u\in\free(\phi)$ and this implies by assumption that
$\sigma(u)\neq\sigma(x)$. Thus:
    \begin{eqnarray*}
    \sigma(u)\in\free(\sigma(\phi_{1}))\setminus\{\sigma(x)\}&=&
    \free(\forall\sigma(x)\sigma(\phi_{1}))\\
    &=&\free(\sigma(\forall x\phi_{1}))\\
    &=&\free(\sigma(\psi))
    \end{eqnarray*}
Hence we see that $\sigma(u)\in\free(\sigma(\psi))$ as requested.
\end{proof}

Looking back at
definition~(\ref{logic:def:FOPL:valid:substitution}), a substitution
$\sigma$ is valid for $\phi$ \ifand\ for all $\psi\in\pv$ we have
the following property:
    \[
    (\psi\preceq\phi)\ \Rightarrow\ [\
    u\in\free(\psi)\ \Rightarrow\
    \sigma(u)\in\free(\sigma(\psi))\ ]
    \]
In the next proposition, we offer another criterion for the validity
of $\sigma$ for $\phi$:
    \[
    (\forall x\phi_{1}\preceq\phi)\ \Rightarrow\ [\
    u\in\free(\forall x\phi_{1})\ \Rightarrow\
    \sigma(u)\neq\sigma(x)\ ]
    \]
This criterion is arguably simpler as we no longer need to check
every sub-formula $\psi\preceq\phi$, but instead can limit our
attention to those sub-formula of the form $\psi=\forall x\phi_{1}$
with $\phi_{1}\in\pv$ and $x\in V$. Furthermore, we no longer need
to establish that $\sigma(u)$ is a free variable of $\sigma(\psi)$,
but instead have to show that $\sigma(u)\neq\sigma(x)$ which is also
a lot simpler.
\begin{prop}\label{logic:prop:FOPL:validsub:criterion}
Let $V$ and $W$ be sets and $\sigma:V\to W$ be a map. Let
$\phi\in\pv$. Then $\sigma$ is valid for $\phi$ \ifand\ for all
$\phi_{1}\in\pv$ and $x\in V$ we have:
    \[
    (\forall x\phi_{1}\preceq\phi)\ \Rightarrow\ [\
    u\in\free(\forall x\phi_{1})\ \Rightarrow\
    \sigma(u)\neq\sigma(x)\ ]
    \]
\end{prop}
\begin{proof}
First we show the 'only if' part: So suppose $\sigma$ is valid for
$\phi$. Let $\phi_{1}\in\pv$ and $x\in V$ such that $\psi=\forall
x\phi_{1}\preceq\phi$ and let $u\in\free(\psi)$. We need to show
that $\sigma(u)\neq\sigma(x)$. However, from the validity of
$\sigma$ for $\phi$ we have $\sigma(u)\in\free(\sigma(\psi))$. So
$\sigma(u)$ is a free variable of
$\sigma(\psi)=\forall\sigma(x)\sigma(\phi_{1})$ and
$\sigma(u)\neq\sigma(x)$ as requested.

We now prove the 'if' part: Consider the property $P_{\sigma}(\phi)$
defined by:
    \[
    \forall\phi_{1}\forall x\ [\ (\forall x\phi_{1}\preceq\phi)\ \Rightarrow\ [\
    u\in\free(\forall x\phi_{1})\ \Rightarrow\
    \sigma(u)\neq\sigma(x)\ ]\ ]
    \]
Then we need to prove that $P_{\sigma}(\phi)\ \Rightarrow\
    (\mbox{$\sigma$ valid for $\phi$})$ for all $\phi\in\pv$.
We shall do so by structural induction, using
theorem~(\ref{logic:the:proof:induction}) of
page~\pageref{logic:the:proof:induction}. First we assume that
$\phi=(x\in y)$ for some $x,y\in V$. We need to show that the
implication is true for $\phi$. So suppose $P_{\sigma}(\phi)$ is
true. We need to show that $\sigma$ is valid for $\phi$, which is
always the case when $\phi=(x\in y)$. Next we assume that
$\phi=\bot$. Then $\sigma$ is once again always valid for $\phi$ and
the implication is true. Next we assume that
$\phi=\phi_{1}\to\phi_{2}$ where the implication is true for
$\phi_{1},\phi_{2}\in\pv$. We need to show that the implication is
also true for $\phi$. So we assume that $P_{\sigma}(\phi)$ is true.
We need to show that $\sigma$ is valid for
$\phi=\phi_{1}\to\phi_{2}$. Using
proposition~(\ref{logic:prop:FOPL:valid:recursion:imp}) it is
sufficient to prove that $\sigma$ is valid for both $\phi_{1}$ and
$\phi_{2}$. Having assumed the implication is true for $\phi_{1}$
and $\phi_{2}$, it is therefore sufficient to prove that
$P_{\sigma}(\phi_{1})$ and $P_{\sigma}(\phi_{2})$ are true. First we
show that $P_{\sigma}(\phi_{1})$ is true. So let $\psi\in\pv$ and
$z\in V$ such that $\forall z\psi\preceq\phi_{1}$. Suppose
$u\in\free(\forall z\psi)$. We need to show that
$\sigma(u)\neq\sigma(z)$. Having assumed $P_{\sigma}(\phi)$ is true,
it is sufficient to prove that $\forall z\psi\preceq\phi$, which
follows immediately from $\forall z\psi\preceq\phi_{1}$ and
$\phi_{1}\preceq\phi$. So we have proved that $P_{\sigma}(\phi_{1})$
is indeed true and a similar argument shows that
$P_{\sigma}(\phi_{2})$ is true. This concludes the case when
$\phi=\phi_{1}\to\phi_{2}$. Next we assume that $\phi=\forall
x\phi_{1}$ where $x\in V$ and the implication is true for
$\phi_{1}\in\pv$. We need to show that the implication is also true
for $\phi$. So we assume that $P_{\sigma}(\phi)$ is true. We need to
show that $\sigma$ is valid for $\phi=\forall x\phi_{1}$. Using
proposition~(\ref{logic:prop:FOPL:valid:recursion:quant}) it is
sufficient to prove that $\sigma$ is valid for $\phi_{1}$ and
furthermore that $\sigma(u)\neq\sigma(x)$ whenever
$u\in\free(\forall x\phi_{1})$. First we show that $\sigma$ is valid
for $\phi_{1}$. Having assumed the implication is true for
$\phi_{1}$, it is sufficient to prove that $P_{\sigma}(\phi_{1})$ is
true. So let $\psi\in\pv$ and $z\in V$ such that $\forall
z\psi\preceq\phi_{1}$. Suppose $u\in\free(\forall z\psi)$. We need
to show that $\sigma(u)\neq\sigma(z)$. Having assumed
$P_{\sigma}(\phi)$ is true, it is sufficient to prove that $\forall
z\psi\preceq\phi$, which follows immediately from $\forall
z\psi\preceq\phi_{1}$ and $\phi_{1}\preceq\phi$. So we have proved
that $P_{\sigma}(\phi_{1})$ is indeed true and $\sigma$ is therefore
valid for $\phi_{1}$. Next we show that $\sigma(u)\neq\sigma(x)$
whenever $u\in\free(\forall x\phi_{1})$. So let $u\in\free(\forall
x\phi_{1})$. We need to show that $\sigma(u)\neq\sigma(x)$. Having
assumed $P_{\sigma}(\phi)$ is true, it is sufficient to prove that
$\forall x\phi_{1}\preceq\phi$ which is immediate since $\forall
x\phi_{1}=\phi$.
\end{proof}

The following proposition is a simple application of
proposition~(\ref{logic:prop:FOPL:valid:injective}):

\begin{prop}\label{logic:prop:FOPL:validsub:singlevar}
Let $V$ be a set and $x,y\in V$. Let $\phi\in\pv$. Then we have:
    \[
    y\not\in\var(\phi)\ \Rightarrow\ (\mbox{$[y/x]$ valid for
    $\phi$})
    \]
\end{prop}
\begin{proof}
We assume that $y\not\in\var(\phi)$. We need to show that the
substitution $[y/x]$ is valid for $\phi$. Using
proposition~(\ref{logic:prop:FOPL:valid:injective}), it is
sufficient to prove that $[y/x]_{|\var(\phi)}$ is an injective map.
This follows immediately from $y\not\in\var(\phi)$ and
proposition~(\ref{logic:prop:FOPL:singlevar:support}).
\end{proof}

If $U$ and $V$ are sets and $\tau:U\to V$ is a valid substitution
for $\phi\in{\bf P}(U)$, then our rule of thumb says it does make
logical sense to speak of $\tau(\phi)$. So if $W$ is another set and
$\sigma:V\to W$ is a substitution which is valid for $\tau(\phi)$,
it should make logical sense to speak of
$\sigma(\tau(\phi))=(\sigma\circ\tau)(\phi)$. So we should expect
the substitution $\sigma\circ\tau$ to be valid for $\phi$. Luckily,
this happens to be true. In fact, the converse is also true: if
$\sigma\circ\tau$ is valid for $\phi$ then not only is $\sigma$ is
valid for $\tau(\phi)$, but surprisingly $\tau$ itself is
necessarily valid for $\phi$.

\begin{prop}\label{logic:prop:FOPL:valid:composition}
Let $U$, $V$, $W$ be sets and $\tau:U\to V$ and $\sigma:V\to W$ be
maps. Then for all $\phi\in{\bf P}(U)$ we have the equivalence:
\[
    (\mbox{$\tau$ valid for $\phi$})\land(\mbox{$\sigma$ valid for
    $\tau(\phi)$})\ \Leftrightarrow\ (\mbox{$\sigma\circ\tau$ valid for
    $\phi$})
\]
where $\tau:{\bf P}(U)\to{\bf P}(V)$ also denotes the associated
substitution mapping.
\end{prop}
\begin{proof}
First we prove $\Rightarrow$: so we assume that $\tau$ is valid for
$\phi\in{\bf P}(U)$ and $\sigma$ is valid for $\tau(\phi)$. We need
to show that $\sigma\circ\tau$ is valid for $\phi$. So let
$\psi\preceq\phi$. Using
proposition~(\ref{logic:prop:FOPL:valid:free:commute}) we need to
show that $\free(\sigma\circ\tau(\psi))
=(\sigma\circ\tau)(\free(\psi))$:
    \begin{eqnarray*}
    \free(\sigma\circ\tau(\psi))&=&\free(\sigma(\tau(\psi)))\\
   (\tau(\psi)\preceq\tau(\phi))\land(\mbox{$\sigma$ valid for $\tau(\phi)$})\rightarrow
   &=&\sigma(\free(\tau(\psi)))\\
   (\psi\preceq\phi)\land(\mbox{$\tau$ valid for $\phi$})
   \rightarrow&=&\sigma(\tau(\free(\psi)))\\
   &=&(\sigma\circ\tau)(\free(\psi))
    \end{eqnarray*}
Note that $\tau(\psi)\preceq\tau(\phi)$ follows from
$\psi\preceq\phi$ and
proposition~(\ref{logic:prop:FOPL:substitution:subformula}). We now
prove~$\Leftarrow$: So suppose $\sigma\circ\tau$ is valid for
$\phi$. We need to show that $\tau$ is valid for~$\phi$ and $\sigma$
is valid for $\tau(\phi)$. First we show that $\sigma$ is valid for
$\tau(\phi)$, having assumed $\tau$ is indeed valid for $\phi$. So
let $\chi\preceq\tau(\phi)$. Using
proposition~(\ref{logic:prop:FOPL:valid:free:commute}) we need to
show that $\free(\sigma(\chi))=\sigma(\free(\chi))$. However from
proposition~(\ref{logic:prop:FOPL:substitution:subformula}), there
exists $\psi\preceq\phi$ such that $\chi=\tau(\psi)$. Hence we have
the following equalities:
    \begin{eqnarray*}
    \free(\sigma(\chi))&=&\free(\sigma(\tau(\psi))\\
    &=&\free(\sigma\circ\tau(\psi))\\
    \mbox{($\psi\preceq\phi$)$\,\land\,$($\sigma\circ\tau$ valid for $\phi$)}\ \rightarrow
    &=&\sigma\circ\tau(\free(\psi))\\
    &=&\sigma(\tau(\free(\psi)))\\
    \mbox{($\psi\preceq\phi$)$\,\land\,$($\tau$ valid for $\phi$)}\ \rightarrow
    &=&\sigma(\free(\tau(\psi)))\\
    &=&\sigma(\free(\chi))
    \end{eqnarray*}
It remains to prove that $\tau$ is valid for $\phi$. So consider the
property:
    \[
    (\mbox{$\sigma\circ\tau$ valid for
    $\phi$})\ \Rightarrow\ (\mbox{$\tau$ valid for $\phi$})
    \]
We need to show this property holds for all $\phi\in{\bf P}(U)$. We
shall do so by a structural induction argument, using
theorem~(\ref{logic:the:proof:induction}) of
page~\pageref{logic:the:proof:induction}. First we assume that
$\phi=(x\in y)$ for some $x,y\in U$. Then $\tau$ is always valid for
$\phi$ and the property is true. Likewise, $\tau$ is always valid
for $\phi=\bot$ and the property is true for~$\bot$. So we assume
that $\phi=\phi_{1}\to\phi_{2}$ where $\phi_{1},\phi_{2}\in{\bf
P}(U)$ satisfy the property. We need to show that same is true of
$\phi$. So we assume that $\sigma\circ\tau$ is valid for $\phi$. We
need to show that $\tau$ is valid for $\phi=\phi_{1}\to\phi_{2}$.
Using proposition~(\ref{logic:prop:FOPL:valid:recursion:imp}) it is
sufficient to prove that $\tau$ is valid for both $\phi_{1}$ and
$\phi_{2}$. First we show that $\tau$ is valid for $\phi_{1}$.
Having assumed the property is true for $\phi_{1}$ it is sufficient
to show that $\sigma\circ\tau$ is valid for $\phi_{1}$, which
follows from the validity of $\sigma\circ\tau$ for
$\phi=\phi_{1}\to\phi_{2}$ and
proposition~(\ref{logic:prop:FOPL:valid:recursion:imp}). We prove
similarly that $\tau$ is valid for $\phi_{2}$ which completes the
case when $\phi=\phi_{1}\to\phi_{2}$. So we now assume that
$\phi=\forall x\phi_{1}$ where $x\in U$ and $\phi_{1}\in{\bf P}(U)$
satisfies our property. We need to show that same is true of~$\phi$.
So we assume that $\sigma\circ\tau$ is valid for $\phi$. We need to
show that $\tau$ is valid for $\phi=\forall x\phi_{1}$. Using
proposition~(\ref{logic:prop:FOPL:valid:recursion:quant}) it is
sufficient to show that $\tau$ is valid for $\phi_{1}$ and
furthermore that $u\in\free(\forall x\phi_{1})\ \Rightarrow\
\tau(u)\neq\tau(x)$. First we show that $\tau$ is valid for
$\phi_{1}$. Having assumed the property is true for $\phi_{1}$ it is
sufficient to prove that $\sigma\circ\tau$ is valid for $\phi_{1}$
which follows from the validity of $\sigma\circ\tau$ for
$\phi=\forall x\phi_{1}$ and
proposition~(\ref{logic:prop:FOPL:valid:recursion:quant}). So we
assume that $u\in\free(\forall x\phi_{1})$ and it remains to show
that $\tau(u)\neq\tau(x)$. So suppose to the contrary that
$\tau(u)=\tau(x)$. Then in particular
$\sigma\circ\tau(u)=\sigma\circ\tau(x)$ which contradicts the
validity of $\sigma\circ\tau$ for $\phi=\forall x\phi_{1}$.
\end{proof}


\begin{prop}\label{logic:prop:FOPL:validsub:image}
Let $V,W$ be sets and $\sigma,\tau:V\to W$ be maps. Let $\phi\in\pv$
such that the equality $\sigma(\phi)=\tau(\phi)$ holds. Then we have
the equivalence:
    \[
    (\mbox{$\sigma$ valid for $\phi$})\ \Leftrightarrow\
    (\mbox{$\tau$ valid for $\phi$})
    \]
\end{prop}
\begin{proof}
So we assume that $\sigma(\phi)=\tau(\phi)$. It is sufficient to
show the implication $\Rightarrow$\,. So we assume that $\sigma$ is
valid for $\phi$. We need to show that $\tau$ is also valid for
$\phi$. So let $\psi\preceq\phi$ be a sub-formula of $\phi$ and
$x\in\free(\psi)$. We need to show that
$\tau(x)\in\free(\tau(\psi))$. However from
proposition~(\ref{logic:prop:substitution:support}) and the equality
$\sigma(\phi)=\tau(\phi)$ we see that $\sigma$ and $\tau$ coincide
on $\var(\phi)$. Furthermore from
proposition~(\ref{logic:prop:FOPL:variable:subformula}) we have
$\var(\psi)\subseteq\var(\phi)$. It follows that $\sigma$ and $\tau$
coincide on $\var(\psi)$ and in particular $\sigma(x)=\tau(x)$.
Using proposition~(\ref{logic:prop:substitution:support}) we also
have $\sigma(\psi)=\tau(\psi)$. Hence we need to show that
$\sigma(x)\in\free(\sigma(\psi))$ which follows from the validity of
$\sigma$ for $\phi$.
\end{proof}

The following proposition will appear later as a useful criterion:
\begin{prop}\label{logic:prop:FOPL:validsub:minimalextension}
Let $V$, $W$ be sets and $\sigma:V\to W$ be a map. Let $\phi\in\pv$.
We assume that there exists a subset $V_{0}\subseteq V$ with the
following properties:
    \begin{eqnarray*}
    (i)&&\bound(\phi)\subseteq V_{0}\\
    (ii)&&\mbox{$\sigma_{|V_{0}}$ is injective}\\
    (iii)&&\sigma(V_{0})\cap\sigma(\var(\phi)\setminus
    V_{0})=\emptyset
    \end{eqnarray*}
Then the map $\sigma:V\to W$ is valid for the formula $\phi\in\pv$.
\end{prop}
\begin{proof}
Let $x\in V$ and $\phi_{1}\in\pv$ such that $\forall
x\phi_{1}\preceq\phi$. Using
proposition~(\ref{logic:prop:FOPL:validsub:criterion}), given
$u\in\free(\forall x\phi_{1})$ we need to show that
$\sigma(u)\neq\sigma(x)$. However, from
proposition~(\ref{logic:prop:FOPL:boundvar:subformula}) we have
$\bound(\forall x\phi_{1})\subseteq\bound(\phi)$ and consequently
$x\in\bound(\phi)$. From the assumption~$(i)$ it follows that $x\in
V_{0}$. We shall now distinguish two cases: first we assume that
$u\in V_{0}$. Then from assumption~$(ii)$, in order to show
$\sigma(u)\neq\sigma(x)$ it is sufficient to prove that $u\neq x$
which follows from $u\in\free(\forall x\phi_{1})$. We now assume
that $u\not\in V_{0}$. However, from
proposition~(\ref{logic:prop:FOPL:variable:subformula}) we have
$\var(\forall x\phi_{1})\subseteq\var(\phi)$ and consequently
$u\in\var(\phi)$. It follows that $u\in\var(\phi)\setminus V_{0}$.
Hence, we see that $\sigma(u)\neq\sigma(x)$ is a consequence of
assumption~$(iii)$ and $x\in V_{0}$.
\end{proof}
