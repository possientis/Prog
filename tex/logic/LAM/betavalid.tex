In the following definition, we attempt to formalize the idea that a
$\beta$-substitution as defined in definition~(\ref{logic:def:LAM:beta:subst})
does not give rise to {\em variable capture}. Given a map $\sigma:V\to\tv$,
we define a map $\kappa_{\sigma}:\tv\to{\cal P}(V)\to\{0,1\}$, the
interpretation of which is as follows: given $\phi\in\tv$ and $U\subseteq V$, 
a value of $\kappa_{\sigma}(\phi)(U)=0$ indicates that {\em variable capture} 
did occur in the substitution $\sigma^{*}(\phi)(U)$ of
definition~(\ref{logic:def:LAM:beta:subst}), indicating that the substitution
is not valid (in relation to $U$) for the formula $\phi$. Otherwise,
if $\kappa_{\sigma}(\phi)(U)=1$ then no {\em variable capture} did occur,
and the ordered pair $(\sigma,U)$ is said to be {\em valid} for $\phi$.
In the case when $\phi=x$ for some $x\in V$, we set $\kappa_{\sigma}(\phi)
(U)=1$ since no {\em variable capture} can arise as a result of the variable
substitution. When $\phi=\phi_{1}\ \phi_{2}$ we set $\kappa_{\sigma}(\phi)(U)$
to be the minimum of $\kappa_{\sigma}(\phi_{1})(U)$ and $\kappa_{\sigma}
(\phi_{2})(U)$, taking the view that no {\em variable capture}
arises from the variable substitution, unless it arises for $\phi_{1}$ or 
$\phi_{2}$. The case when $\phi=\lambda x\phi_{1}$ is the most diffcult
one: since we have:
    \[
        \sigma^{*}(\lambda x \phi_{1})(U)
        =
        \lambda x \,\sigma^{*}(\phi_{1})(U\cup\{x\})
    \]
a necessary condition to avoid {\em variable capture} is that no {\em 
variable capture} occurs in $\sigma^{*}(\phi_{1})(U\cup\{x\})$. However,
we also expect any $u\in\free(\lambda x\phi_{1})\setminus U$ to be 
{\em replaced} by $\sigma(u)$ after the substitution. Hence we must have
$x\not\in\free(\sigma(u))$, as otherwise a free variable of $\sigma(u)$
would get {\em captured} by $x$. This motivate the following:
\begin{defin}\label{logic:def:LAM:beta:valid:substitution}
    Let $V$ be a set and $\sigma:V\to\tv$ be a map. We call {\em validity
    index mapping associated with $\sigma$} the map $\kappa_{\sigma}:\tv
    \to{\cal P}(V)\to\{0,1\}$ defined by the following structural induction,
    given $\phi\in\tv$ and $U\subseteq V$:
        \begin{equation}\label{logic:eqn:LAM:index}
            \kappa_{\sigma}(\phi)(U)=\left\{
                \begin{array}{lcl}
                    1&\mbox{\ if\ }&\phi=x\\
                    \kappa_{\sigma}(\phi_{1})(U)\,\land\,
                    \kappa_{\sigma}(\phi_{2})(U)
                    &\mbox{\ if\ }&\phi=\phi_{1}\ \phi_{2}\\
                    \epsilon\,\land\,\kappa_{\sigma}(\phi_{1})(U\cup\{x\})
                    &\mbox{\ if\ }&\phi=\lambda x\phi_{1}
            \end{array}\right.
        \end{equation} 
    where it is understood in the above equation that $\epsilon\in\{0,1\}$ 
    and $\epsilon=1$ holds \ifand\ the following implication is true 
    for all $u\in V$:
        \[
            u\in\free(\lambda x\phi_{1})\setminus U
                \ \Rightarrow\ 
            x\not\in\free(\sigma(u))
        \]
    We say that $(\sigma,U)$ is {\em $\beta$-valid for} $\phi$ \ifand\ 
    $\kappa_{\sigma}(\phi)(U)=1$. \newline
    We say that $\sigma$ is $\beta$-valid for $\phi$ \ifand\
    $(\sigma,\emptyset)$ is $\beta$-valid for $\phi$.
\end{defin}

\begin{prop}\label{logic:prop:LAM:beta:valid:recursion:x:gen}
    Let $V$ be a set and $\sigma:V\to\tv$ be a map. Let $\phi\in\tv$
    of the form $\phi=x$ with $x\in V$. Then for all $U\subseteq V$, 
    $(\sigma,U)$ is $\beta$-valid for $\phi$.
\end{prop}
\begin{proof}
    This follows immediately from 
    definition~(\ref{logic:def:LAM:beta:valid:substitution}) and $\kappa_{
        \sigma}(\phi)(U)=1$.
\end{proof}
\begin{prop}\label{logic:prop:LAM:beta:valid:recursion:x}
    Let $V$ be a set and $\sigma:V\to\tv$ be a map. Let $\phi\in\tv$
    of the form $\phi=x$ with $x\in V$. Then 
    $\sigma$ is $\beta$-valid for $\phi$.
\end{prop}
\begin{proof}
    This follows immediately from 
    proposition~(\ref{logic:prop:LAM:beta:valid:recursion:x:gen}) using 
    $U=\emptyset$.
\end{proof}

\begin{prop}\label{logic:prop:LAM:beta:valid:recursion:app:gen}
    Let $V$ be a set and $\sigma:V\to\tv$ be a map. Let $\phi\in\tv$ 
    of the form $\phi=\phi_{1}\ \phi_{2}$ with $\phi_{1},\phi_{2}\in\tv$. 
    Then for all $U\subseteq V$,  $(\sigma,U)$ is $\beta$-valid for $\phi$ 
    \ifand\ it is $\beta$-valid for both $\phi_{1}$ and $\phi_{2}$.
\end{prop}
\begin{proof}
    $(\sigma,U)$ is $\beta$-valid for $\phi$ \ifand\ $\kappa_{\sigma}(\phi)(U)
    =1$ which is the same as $\kappa_{\sigma}(\phi_{1})(U)\land\kappa_{\sigma}
    (\phi_{2})(U)=1$. This in turn is equivalent to $\kappa_{\sigma}
    (\phi_{1})(U)=1$ and $\kappa_{\sigma}(\phi_{2})(U)=1$. So it is 
    equivalent to $(\sigma,U)$ being $\beta$-valid for both $\phi_{1}$ and
    $\phi_{2}$.
\end{proof}

\begin{prop}\label{logic:prop:LAM:beta:valid:recursion:app}
    Let $V$ be a set and $\sigma:V\to\tv$ be a map. Let $\phi\in\tv$ 
    of the form $\phi=\phi_{1}\ \phi_{2}$ with $\phi_{1},\phi_{2}\in\tv$. 
    Then $\sigma$ is $\beta$-valid for $\phi$ 
    \ifand\ it is $\beta$-valid for both $\phi_{1}$ and $\phi_{2}$.
\end{prop}
\begin{proof}
    This follows immediately from 
    proposition~(\ref{logic:prop:LAM:beta:valid:recursion:app:gen}) using 
    $U=\emptyset$.
\end{proof}

\begin{prop}\label{logic:prop:LAM:beta:valid:recursion:lam:gen}
    Let $V$ be a set and $\sigma:V\to\tv$ be a map. Let $\phi\in\tv$ 
    of the form $\phi=\lambda x\phi_{1}$ with $\phi_{1}\in\tv$ and $x\in V$. 
    Then for all $U\subseteq V$, $(\sigma,U)$ is $\beta$-valid for $\phi$ 
    \ifand\ $(\sigma, U\cup\{x\})$ is $\beta$-valid for $\phi_{1}$ and for 
    all $u\in V$:
    \[
        u\in\free(\lambda x\phi_{1})\setminus U
        \ \Rightarrow\ 
        x\not\in\free(\sigma(u))
    \]
\end{prop}
\begin{proof}
    From definition~(\ref{logic:def:LAM:beta:valid:substitution}), $(\sigma,U)$
    is $\beta$-valid for $\phi$ \ifand\ $\kappa_{\sigma}(\phi)(U)=1$ which is
    $\epsilon\land\kappa_{\sigma}(\phi_{1})(U\cup\{x\})=1$. This is turn is
    equivalent to $\kappa_{\sigma}(\phi_{1})(U\cup\{x\})=1$ together with 
    $\epsilon=1$. So it is equivalent to $(\sigma,U\cup\{x\})$ being 
    $\beta$-valid for $\phi_{1}$ together with $\epsilon=1$. The proposition
    follows from the fact that $\epsilon=1$ is itself equivalent to the
    above implication being true for all $u\in V$.
\end{proof}
