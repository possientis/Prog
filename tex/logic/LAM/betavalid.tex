\begin{defin}\label{logic:def:LAM:beta:valid:substitution}
Let $V$ be a set and $\sigma:V\to\tv$ be a map. Let
$\phi\in\tv$. We say that $\sigma$ is {\em $\beta$-valid for} $\phi$ \ifand\
for every sub-formula $\psi\preceq\phi$:
    \[
        x\in\free(\psi)\ \Rightarrow\ \free(\sigma(x))\subseteq\free(\sigma(\psi))
    \]
where $\sigma:\tv\to\tv$ also denotes the associated
$\beta$-substitution mapping.
\end{defin}

\begin{prop}\label{logic:prop:LAM:beta:valid:subformula}
Let $V$ be a set and $\sigma:V\to\tv$ be a map. Let
$\phi\in\tv$. Then $\sigma$ is $\beta$-valid for $\phi$ \ifand\ it is $\beta$-valid
for any sub-formula $\psi\preceq\phi$.
\end{prop}
\begin{proof}
Since $\phi\preceq\phi$, i.e. $\phi$ is a sub-formula of itself, the
'if' part of this proposition is clear. So we now prove the 'only
if' part. So suppose $\sigma$ is $\beta$-valid for $\phi$ and let
$\psi\preceq\phi$. We need to show that $\sigma$ is also $\beta$-valid for
$\psi$. So let $\chi\preceq\psi$ and let $x\in\free(\chi)$. We need
    to show that $\free(\sigma(x))\subseteq\free(\sigma(\chi))$, which follows
immediately from the $\beta$-validity of $\sigma$ for $\phi$ and the fact
(by transitivity) that $\chi\preceq\phi$, i.e. that $\chi$ is also a
sub-formula of $\phi$.
\end{proof}

\begin{prop}\label{logic:prop:LAM:beta:valid:free:commute}
Let $V$ be a set and $\sigma:V\to\tv$ be a map. Let $\phi\in\tv$. 
Then $\sigma$ is $\beta$-valid for $\phi$ \ifand\ for every 
subformula $\psi\preceq\phi$, we have:
    \[
        \free(\sigma(\psi))
        =
        \bigcup_{x\in\free(\psi)} \free(\sigma(x))
    \]
\end{prop}
\begin{proof}
    From definition~(\ref{logic:def:LAM:beta:valid:substitution}), the 
    $\beta$-validity of $\sigma$ for $\phi$ is equivalent to the implication:
    \[
        x\in\free(\psi)\ \Rightarrow\ 
            \free(\sigma(x))
            \subseteq
            \free(\sigma(\psi))
    \]
    holding for every $\psi\preceq\phi$. This implication is in turn 
    equivalent to the inclusion:
    \[
        \bigcup_{x\in\free(\psi)} \free(\sigma(x))
        \subseteq
        \free(\sigma(\psi))
    \]
    which corresponds to the inclusion $\supseteq$ of the above equality. However,
    from proposition~(\ref{logic:prop:LAM:freevar:of:betasubst:inclusion}), 
    the reverse inclusion $\subseteq$ is always true. Hence, the above equality 
    is equivalent to $\supseteq$ which is equivalent to the $\beta$-validity 
    of $\sigma$ for $\phi$.
\end{proof}

The following proposition is similar to 
proposition~(\ref{logic:prop:LAM:freevar:of:betasubst:gen}). However,
it relies on the stronger assumption of $\beta$-validity and yields the
stronger conclusion of equality rather than inclusion.
\begin{prop}\label{logic:prop:LAM:freevar:of:betasubst:gen:valid}
Let $V$ be a set and $\phi\in\tv$. Let $\sigma:V\to\tv$ be a map which is
$\beta$-valid for $\phi$. Then for all $U\subseteq V$ we have:
    \[
        \free(\sigma^{*}(\phi)(U)) 
            \ =\ 
        (\free(\phi)\cap U)\ \ \ 
            \cup
        \bigcup_{x\in\free(\phi)\setminus U} \free(\sigma(x))
    \]
where $\sigma^{*}:\tv\to[{\cal P}(V)\to\tv]$ is defined as in 
definition~(\ref{logic:def:LAM:subst}).
\end{prop}
\begin{proof}
We shall prove this equality by structural induction on $\phi$, using
theorem~(\ref{logic:the:proof:induction}) of 
page~\pageref{logic:the:proof:induction}. So first we assume that $\phi=x$ 
for some $x\in V$. Then for all $U\subseteq V$, there are two possible cases: 
either $x\in U$ or $x\not\in U$. If $x\in U$ we have:
    \begin{eqnarray*}
        \free(\sigma^{*}(\phi)(U))
        &=&\free(\sigma^{*}(x)(U))\\
        &=&\free(\sigma_{U}(x))\\
        \mbox{$x\in U\ \rightarrow\ $}&=&\free(x)\\
         &=&\{x\}\\
         &=&\free(\phi)\\
        \mbox{$x\in U\ \rightarrow\ $}&=&\free(\phi)\cap U\\
        \mbox{$\free(\phi)\setminus U = \emptyset\ \rightarrow\ $} &=& 
            (\free(\phi)\cap U)\ \ \ \cup
            \bigcup_{x\in\free(\phi)\setminus U} \free(\sigma(x))
    \end{eqnarray*}
\end{proof}

\begin{prop}\label{logic:prop:LAM:beta:valid:recursion:app}
    Let $V$ be a set and $\sigma:V\to\tv$ be a map. Let $\phi\in\tv$ 
    of the form $\phi=\phi_{1}\ \phi_{2}$ with $\phi_{1},\phi_{2}\in\tv$. 
    Then $\sigma$ is $\beta$-valid for $\phi$ \ifand\ it is $\beta$-valid 
    for both $\phi_{1}$ and $\phi_{2}$.
\end{prop}
\begin{proof}
    First we assume that $\sigma$ is $\beta$-valid for $\phi$. We need to 
    show that it is $\beta$-valid for both $\phi_{1}$ and $\phi_{2}$. 
    However, both $\phi_{1}$ and $\phi_{2}$ are sub-formulas of $\phi$.
    So this follows immediately from 
    proposition~(\ref{logic:prop:LAM:beta:valid:subformula}). 
    Conversely, we assume that $\sigma$ is $\beta$-valid for both $\phi_{1}$
    and $\phi_{2}$. We need to show it is $\beta$-valid for $\phi$. So let
    $\psi\preceq\phi$ be a sub-formula of $\phi$ and $x\in\free(\psi)$.
    We need to show the inclusion $\free(\sigma(x))\subseteq\free(\sigma(\psi))$.
    However since $\psi\preceq\phi$ and $\phi=\phi_{1}\ \phi_{2}$, $\psi$ 
    must be a sub-formula of $\phi_{1}$, or a sub-formula of $\phi_{2}$, 
    or it must be equal to $\phi$ itself. If $\psi\preceq\phi_{1}$, having
    assumed that $\sigma$ is $\beta$-valid for $\phi_{1}$, the desired 
    inclusion must hold. Likewise if $\psi\preceq\phi_{2}$, having assumed
    that $\phi$ is $\beta$-valid for $\phi_{2}$, the desired inclusion 
    must hold. So we assume that $\psi=\phi$. Since 
    $x\in\free(\psi)=\free(\phi_{1})\cup\free(\phi_{2})$, $x$ must be an 
    element of $\free(\phi_{1})$ or $\free(\phi_{2})$. If $x\in\free(\phi_{1})$,
    from $\phi_{1}\preceq\phi_{1}$ and the $\beta$-validity of $\sigma$ for 
    $\phi_{1}$ we see that $\free(\sigma(x))\subseteq\free(\sigma(\phi_{1}))$.
    However we have $\sigma(\phi)=\sigma(\phi_{1})\ \sigma(\phi_{2})$ from 
    proposition~(\ref{logic:prop:LAM:subst:app}) and consequently
    $\free(\sigma(\phi))=\free(\sigma(\phi_{1}))\cup\free(\sigma(\phi_{2}))$.
    In particular $\free(\sigma(\phi_{1}))\subseteq\free(\sigma(\phi))$ and
    it follows that 
    $\free(\sigma(x))\subseteq\free(\sigma(\phi))$, that is
    $\free(\sigma(x))\subseteq\free(\sigma(\psi))$ as desired.
    The case $x\in\free(\phi_{2})$ is handled similarly.
\end{proof}
