\begin{defin}\label{logic:def:LAM:beta:valid:substitution}
    Let $V$ be a set and $\sigma:V\to\tv$ be a map. Let
    $\phi\in\tv$. We say that $\sigma$ is {\em $\beta$-valid for} $\phi$ 
    \ifand\ for every sub-formula $\psi\preceq\phi$:
    \[
        x\in\free(\psi)\ 
            \Rightarrow\ 
        \free(\sigma(x))\subseteq\free(\sigma(\psi))
    \]
    where $\sigma:\tv\to\tv$ also denotes the associated $\beta$-substitution 
    mapping.
\end{defin}

\begin{prop}\label{logic:prop:LAM:beta:valid:subformula}
    Let $V$ be a set and $\sigma:V\to\tv$ be a map. Let $\phi\in\tv$. 
    Then $\sigma$ is $\beta$-valid for $\phi$ \ifand\ it is $\beta$-valid
    for any sub-formula $\psi\preceq\phi$.
\end{prop}
\begin{proof}
    Since $\phi\preceq\phi$, i.e. $\phi$ is a sub-formula of itself, the
    'if' part of this proposition is clear. So we now prove the 'only
    if' part. So suppose $\sigma$ is $\beta$-valid for $\phi$ and let
    $\psi\preceq\phi$. We need to show that $\sigma$ is also $\beta$-valid for
    $\psi$. So let $\chi\preceq\psi$ and let $x\in\free(\chi)$. We need
    to show that $\free(\sigma(x))\subseteq\free(\sigma(\chi))$, which follows
    immediately from the $\beta$-validity of $\sigma$ for $\phi$ and the fact
    (by transitivity) that $\chi\preceq\phi$, i.e. that $\chi$ is also a
    sub-formula of $\phi$.
\end{proof}

\begin{prop}\label{logic:prop:LAM:beta:valid:free:commute}
    Let $V$ be a set and $\sigma:V\to\tv$ be a map. Let $\phi\in\tv$. 
    Then $\sigma$ is $\beta$-valid for $\phi$ \ifand\ for every 
    subformula $\psi\preceq\phi$, we have:
    \[
        \free(\sigma(\psi))
        =\!\!\!\!
        \bigcup_{x\in\free(\psi)} 
        \!\!\!\!
        \free(\sigma(x))
    \]
\end{prop}
\begin{proof}
    From definition~(\ref{logic:def:LAM:beta:valid:substitution}), the 
    $\beta$-validity of $\sigma$ for $\phi$ is equivalent to the implication:
    \[
        x\in\free(\psi)\ \Rightarrow\ 
            \free(\sigma(x))
            \subseteq
            \free(\sigma(\psi))
    \]
    holding for every $\psi\preceq\phi$. This implication is in turn 
    equivalent to the inclusion:
    \[
        \bigcup_{x\in\free(\psi)} \!\!\!\!\free(\sigma(x))
        \subseteq
        \free(\sigma(\psi))
    \]
    which corresponds to the inclusion $\supseteq$ of the above equality. However,
    from proposition~(\ref{logic:prop:LAM:freevar:of:betasubst:inclusion}), 
    the reverse inclusion $\subseteq$ is always true. Hence, the above equality 
    is equivalent to $\supseteq$ which is equivalent to the $\beta$-validity 
    of $\sigma$ for $\phi$.
\end{proof}


The following proposition is similar to 
proposition~(\ref{logic:prop:LAM:freevar:of:betasubst:gen}). However,
it relies on the stronger assumption of $\beta$-validity and yields the
stronger conclusion of equality rather than inclusion.

\begin{prop}\label{logic:prop:LAM:freevar:of:betasubst:gen:valid}
    Let $V$ be a set and $\phi\in\tv$. Let $\sigma:V\to\tv$ be a map 
    which is $\beta$-valid for $\phi$. Then for all $U\subseteq V$ we have:
    \[
        \free(\sigma^{*}(\phi)(U)) 
            \ =\ 
        (\free(\phi)\cap U)
        \ \cup
        \!\!\!\!\!\!
        \bigcup_{x\in\free(\phi)\setminus U} 
        \!\!\!\!\!\!
        \free(\sigma(x))
    \]
    where $\sigma^{*}:\tv\to[{\cal P}(V)\to\tv]$ is defined as in 
    definition~(\ref{logic:def:LAM:beta:subst}).
\end{prop}
\begin{proof}
    We shall prove this equality by structural induction on $\phi$, using
    theorem~(\ref{logic:the:proof:induction}) of 
    page~\pageref{logic:the:proof:induction}. So first we assume that $\phi=x$ 
    for some $x\in V$. Then for all $U\subseteq V$, there are two possible 
    cases: either $x\in U$ or $x\not\in U$. If $x\in U$ we have:
    \begin{eqnarray*}
        \free(\sigma^{*}(\phi)(U))
        &=&\free(\sigma^{*}(x)(U))\\
        &=&\free(\sigma_{U}(x))\\
        \mbox{$x\in U\ \rightarrow\ $}&=&\free(x)\\
         &=&\{x\}\\
         &=&\free(\phi)\\
        \mbox{$x\in U\ \rightarrow\ $}&=&\free(\phi)\cap U\\
        \mbox{$\free(\phi)\setminus U = \emptyset\ \rightarrow\ $} &=& 
            (\free(\phi)\cap U)
            \ \cup
            \!\!\!\!\!\!
            \bigcup_{x\in\free(\phi)\setminus U} 
            \!\!\!\!\!\!
            \free(\sigma(x))
    \end{eqnarray*}
    If $x\not\in U$, then:
    \begin{eqnarray*}
        \free(\sigma^{*}(\phi)(U))
        &=&\free(\sigma^{*}(x)(U))\\
        &=&\free(\sigma_{U}(x))\\
        \mbox{$x\not\in U\ \rightarrow\ $}&=&\free(\sigma(x))\\
        &=&
        \!\!\!
        \bigcup_{u\in\{x\}} 
        \!\!
        \free(\sigma(u))\\
        &=&
        \!\!\!\!\!
        \bigcup_{u\in\free(\phi)} 
        \!\!\!\!
        \free(\sigma(u))\\
        \mbox{$x\not\in U\ \rightarrow\ $}
        &=&
        \!\!\!\!\!\!\!\!
        \bigcup_{u\in\free(\phi)\setminus U} 
        \!\!\!\!\!\!\!\!
        \free(\sigma(u))\\
        \mbox{$\free(\phi)\cap U = \emptyset\ \rightarrow\ $} 
        &=& 
        (\free(\phi)\cap U)
        \ \cup
        \!\!\!\!\!\!\!
        \bigcup_{x\in\free(\phi)\setminus U} 
        \!\!\!\!\!\!\!
        \free(\sigma(x))
    \end{eqnarray*}
    We now assume that $\phi=\phi_{1}\ \phi_{2}$ and $\sigma$ is $\beta$-valid 
    for $\phi$, where $\phi_{1}, \phi_{2}\in\tv$ satisfy the equality for all 
    $\sigma$ $\beta$-valid and $U\subseteq V$. Since both $\phi_{1}$ and 
    $\phi_{2}$ are sub-formulas of $\phi$ using  
    proposition~(\ref{logic:prop:LAM:beta:valid:subformula}) we see that 
    $\sigma$ is $\beta$-valid for both $\phi_{1}$ and $\phi_{2}$. Hence, for 
    all $U\subseteq V$ we have:
    \begin{eqnarray*}
        \free(\sigma^{*}(\phi)(U))
        &=&\free(\sigma^{*}(\phi_{1}\ \phi_{2})(U))\\
        &=&\free(\ \sigma^{*}(\phi_{1})(U)\ \ \sigma^{*}(\phi_{2})(U)\ )\\
        &=&\free(\sigma^{*}(\phi_{1})(U))\ \cup\ \free(\sigma^{*}(\phi_{2})(U))\\
        \mbox{$\sigma$ $\beta$-valid for $\phi_{1}\ \rightarrow\ $}
        &=&(\free(\phi_{1})\cap U)
        \ \cup\ 
        \!\!\!\!\!\!\!\!\!\!
        \bigcup_{x\in\free(\phi_{1})\setminus U} 
        \!\!\!\!\!\!\!\!
        \free(\sigma(x))\\
        \mbox{$\sigma$ $\beta$-valid for $\phi_{2}\ \rightarrow\ $}
        &\cup&(\free(\phi_{2})\cap U)
        \ \cup\ 
        \!\!\!\!\!\!\!\!\!\!
        \bigcup_{x\in\free(\phi_{2})\setminus U} 
        \!\!\!\!\!\!\!\!
        \free(\sigma(x))\\
        &=&(\free(\phi_{1})\cup\free(\phi_{2}))\cap U
        \ \cup\ 
        \!\!\!\!\!\!\!\!\!\!\!\!\!\!\!\!\!\!\!\!
        \bigcup_{x\in(\free(\phi_{1})\cup\free(\phi_{2}))\setminus U}
        \!\!\!\!\!\!\!\!\!\!\!\!\!\!\!\!\!\!\!
        \free(\sigma(x))\\
        &=&(\free(\phi)\cap U)\ \cup\ 
        \!\!\!\!\!\!\!\!
        \bigcup_{x\in\free(\phi)\setminus U}
        \!\!\!\!\!\!\!
        \free(\sigma(x))
    \end{eqnarray*}
    Finally, we assume that $\phi=\lambda x\phi_{1}$ and $\sigma$ is 
    $\beta$-valid for $\phi$ where $\phi_{1}\in\tv$ satisfies the equality 
    for all $\sigma$ $\beta$-valid and $U\subseteq V$. Since $\phi_{1}$ is 
    a sub-formula of $\phi$ using 
    proposition~(\ref{logic:prop:LAM:beta:valid:subformula}) we see that 
    $\sigma$ is $\beta$-valid for $\phi_{1}$. Hence, for all $U\subseteq V$:
    \begin{eqnarray*}
        \free(\ \sigma^{*}(\phi)(U)\ )
        &=&\free(\ \sigma^{*}(\lambda x\phi_{1})(U)\ )\\
        &=&\free(\ \lambda x\sigma^{*}(\phi_{1})(U\cup\{x\})\ )\\
        &=&\free(\ \sigma^{*}(\phi_{1})(U\cup\{x\})\ )\setminus\{x\}\\
        \mbox{$\sigma$ $\beta$-valid for $\phi_{1}\ \rightarrow\ $}
        &=& [\ (\free(\phi_{1})\cap(U\cup\{x\}))
        \ \cup\ 
        \!\!\!\!\!\!\!\!\!\!\!\!\!\!\!\!\!
        \bigcup_{u\in\free(\phi_{1})\setminus(U\cup\{x\})}
        \!\!\!\!\!\!\!\!\!\!\!\!\!\!\!
        \free(\sigma(u))
        \ ]\setminus\{x\}\\
        &=&(\free(\phi_{1})\cap U\cap \{x\}^{c})
        \ \cup\ 
        \!\!\!\!\!\!\!\!\!\!\!\!\!\!\!\!\!\!
        \bigcup_{u\in\free(\phi_{1})\cap U^{c}\cap\{x\}^{c}}
        \!\!\!\!\!\!\!\!\!\!\!\!\!\!\!\!
        \free(\sigma(u))\setminus\{x\}\\
        &=&(\free(\lambda x\phi_{1})\cap U)
        \ \cup\ 
        \!\!\!\!\!\!\!\!\!\!\!\!\!
        \bigcup_{u\in\free(\lambda x\phi_{1})\setminus U}
        \!\!\!\!\!\!\!\!\!\!\!
        \free(\sigma(u))\setminus\{x\}\\
        &=&(\free(\phi)\cap U)
        \ \cup\ 
        \!\!\!\!\!\!\!\!\!
        \bigcup_{u\in\free(\phi)\setminus U} 
        \!\!\!\!\!\!\!
        \free(\sigma(u))\setminus\{x\}\\
        \mbox{see below $\ \rightarrow\ $}
        &=&(\free(\phi)\cap U)
        \ \cup\ 
        \!\!\!\!\!\!\!\!\!
        \bigcup_{u\in\free(\phi)\setminus U}
        \!\!\!\!\!\!\!
        \free(\sigma(u))
    \end{eqnarray*}
    In order to jusfify the last equality, it is sufficient to prove
    that $\free(\sigma(u))\subseteq\{x\}^{c}$ for all $u\in\free(\phi)$.
    However, by assumption $\sigma$ is $\beta$-valid for $\phi$. Hence
    for all $u\in\free(\phi)$ looking at 
    definition~(\ref{logic:def:LAM:beta:valid:substitution}) we have 
    $\free(\sigma(u))\subseteq\free(\sigma(\phi))$ and it is therefore 
    sufficient to prove the inclusion $\free(\sigma(\phi))\subseteq\{x\}^{c}$,
    which follows from:
    \begin{eqnarray*}
        \free(\sigma(\phi))
        &=&\free(\sigma^{*}(\phi)(\emptyset))\\
        &=&\free(\sigma^{*}(\lambda x\phi_{1})(\emptyset))\\
        \mbox{def.~(\ref{logic:def:LAM:beta:subst})$\ \rightarrow\ $}
        &=&\free(\lambda x \sigma^{*}(\phi_{1})(\{x\}))\\
        \mbox{def.~(\ref{logic:def:LAM:free:variable})$\ \rightarrow\ $}
        &=&\free(\sigma^{*}(\phi_{1})(\{x\}))\setminus\{x\}\\
        &\subseteq&\{x\}^{c}
    \end{eqnarray*}
\end{proof}

\begin{prop}\label{logic:prop:LAM:beta:valid:recursion:app}
    Let $V$ be a set and $\sigma:V\to\tv$ be a map. Let $\phi\in\tv$ 
    of the form $\phi=\phi_{1}\ \phi_{2}$ with $\phi_{1},\phi_{2}\in\tv$. 
    Then $\sigma$ is $\beta$-valid for $\phi$ \ifand\ it is $\beta$-valid 
    for both $\phi_{1}$ and $\phi_{2}$.
\end{prop}
\begin{proof}
    First we assume that $\sigma$ is $\beta$-valid for $\phi$. We need to 
    show that it is $\beta$-valid for both $\phi_{1}$ and $\phi_{2}$. 
    However, both $\phi_{1}$ and $\phi_{2}$ are sub-formulas of $\phi$.
    So this follows immediately from 
    proposition~(\ref{logic:prop:LAM:beta:valid:subformula}). 
    Conversely, we assume that $\sigma$ is $\beta$-valid for both $\phi_{1}$
    and $\phi_{2}$. We need to show it is $\beta$-valid for $\phi$. So let
    $\psi\preceq\phi$ be a sub-formula of $\phi$ and $x\in\free(\psi)$.
    We need to show the inclusion $\free(\sigma(x))\subseteq\free(\sigma(\psi))$.
    However since $\psi\preceq\phi$ and $\phi=\phi_{1}\ \phi_{2}$, $\psi$ 
    must be a sub-formula of $\phi_{1}$, or a sub-formula of $\phi_{2}$, 
    or it must be equal to $\phi$ itself. If $\psi\preceq\phi_{1}$, having
    assumed that $\sigma$ is $\beta$-valid for $\phi_{1}$, the desired 
    inclusion must hold. Likewise if $\psi\preceq\phi_{2}$, having assumed
    that $\phi$ is $\beta$-valid for $\phi_{2}$, the desired inclusion 
    must hold. So we assume that $\psi=\phi$. Since 
    $x\in\free(\psi)=\free(\phi_{1})\cup\free(\phi_{2})$, $x$ must be an 
    element of $\free(\phi_{1})$ or $\free(\phi_{2})$. If $x\in\free(\phi_{1})$,
    from $\phi_{1}\preceq\phi_{1}$ and the $\beta$-validity of $\sigma$ for 
    $\phi_{1}$ we see that $\free(\sigma(x))\subseteq\free(\sigma(\phi_{1}))$.
    However we have $\sigma(\phi)=\sigma(\phi_{1})\ \sigma(\phi_{2})$ from 
    proposition~(\ref{logic:prop:LAM:subst:app}) and consequently
    $\free(\sigma(\phi))=\free(\sigma(\phi_{1}))\cup\free(\sigma(\phi_{2}))$.
    In particular $\free(\sigma(\phi_{1}))\subseteq\free(\sigma(\phi))$ and
    it follows that 
    $\free(\sigma(x))\subseteq\free(\sigma(\phi))$, that is
    $\free(\sigma(x))\subseteq\free(\sigma(\psi))$ as desired.
    The case $x\in\free(\phi_{2})$ is handled similarly.
\end{proof}

\begin{prop}\label{logic:prop:LAM:beta:valid:recursion:lam}
    Let $V$ be a set and $\sigma:V\to\tv$ be a map. Let $\phi\in\tv$ 
    of the form $\phi=\lambda x\phi_{1}$ with $\phi_{1}\in\tv$ and $x\in V$. 
    Then $\sigma$ is $\beta$-valid for $\phi$ \ifand\ it is $\beta$-valid 
    for $\phi_{1}$ and for all $u\in V$ we have:
    \[
        u\in\free(\lambda x\phi_{1})\ \Rightarrow\ x\not\in\free(\sigma(u))
    \]
\end{prop}
\begin{proof}
    First we show the 'only if' part. So suppose $\sigma$ is $\beta$-valid
    for $\phi=\lambda x\phi_{1}$. Since $\phi_{1}\preceq\phi$, from
    proposition~(\ref{logic:prop:LAM:beta:valid:subformula}) we immediately
    see that $\sigma$ is $\beta$-valid for $\phi_{1}$. So given
    $u\in\free(\lambda x \phi_{1})=\free(\phi)$ it remains to show that
    $x\not\in\free(\sigma(u))$. However, from the $\beta$-validity of 
    $\sigma$ for $\phi$ and $u\in\free(\phi)$ we obtain
    $\free(\sigma(u))\subseteq\free(\sigma(\phi))$. Hence it is sufficient
    to show that $x\not\in\free(\sigma(\phi))$ which follows from:
    \begin{eqnarray*}
        \free(\sigma(\phi))
        &=&\free(\sigma^{*}(\lambda x\phi_{1})(\emptyset))\\
        \mbox{def.~(\ref{logic:def:LAM:beta:subst})$\ \rightarrow\ $}
        &=&\free(\lambda x \sigma^{*}(\phi_{1})(\{x\}))\\
        \mbox{def.~(\ref{logic:def:LAM:free:variable})$\ \rightarrow\ $}
        &=&\free(\sigma^{*}(\phi_{1})(\{x\}))\setminus\{x\}
    \end{eqnarray*}
    We now prove the 'if part'. So we assume that $\sigma$ is $\beta$-valid
    for $\phi_{1}$ and furthermore that for all $u\in\free(\lambda x\phi_{1})$
    we have $x\not\in\free(\sigma(u))$. We need to show that $\sigma$ is 
    $\beta$-valid for $\phi=\lambda x\phi_{1}$. So let $\psi\preceq\phi$ and 
    $u\in\free(\psi)$. We need to show that 
    $\free(\sigma(u))\subseteq\free(\sigma(\psi))$. However from 
    $\psi\preceq\lambda x\phi_{1}$ we see that either $\psi\preceq\phi_{1}$
    or $\psi=\lambda x\phi_{1}$. When $\psi\preceq\phi_{1}$, the inclusion
    $\free(\sigma(u))\subseteq\free(\sigma(\psi))$ follows immediately
    from the $\beta$-validity of $\sigma$ for $\phi_{1}$. Hence we assume 
    that $\psi=\lambda x\phi_{1}=\phi$. Then from $u\in\free(\psi)$ we
    obtain $u\in\free(\lambda x\phi_{1})$ and by assumption, this implies
    that $x\not\in\free(\sigma(u))$, and it remains to show that 
    $\free(\sigma(u))\subseteq\free(\sigma(\phi))$, which is
    $\free(\sigma(u))\subseteq\free(\sigma^{*}(\phi_{1})(\{x\}))\setminus\{x\}$.
    From $x\not\in\free(\sigma(u))$ we already know that 
    $\free(\sigma(u))\subseteq\{x\}^{c}$ and it remains to show that
    $\free(\sigma(u))\subseteq\free(\sigma^{*}(\phi_{1})(\{x\}))$. However, from 
    proposition~(\ref{logic:prop:LAM:freevar:of:betasubst:gen:valid}) using the 
    $\beta$-validity of $\sigma$ for $\phi_{1}$, we have:
    \begin{eqnarray*}
        \free(\sigma^{*}(\phi_{1})(\{x\}))
        &=&(\free(\phi_{1})\cap\{x\})
        \ \cup\ 
        \!\!\!\!\!\!\!\!\!\!\!\!
        \bigcup_{v\in\free(\phi_{1})\setminus\{x\}} 
        \!\!\!\!\!\!\!\!\!\!
        \free(\sigma(v))\\
        &=&(\free(\phi_{1})\cap\{x\})
        \ \cup\ 
        \!\!\!\!\!\!\!\!\!
        \bigcup_{v\in\free(\lambda x\phi_{1})} 
        \!\!\!\!\!\!\!\!
        \free(\sigma(v))
    \end{eqnarray*}
    and the inclusion 
    $\free(\sigma(u))\subseteq\free(\sigma^{*}(\phi_{1})(\{x\}))$
    follows from $u\in\free(\lambda x\phi_{1})$.
\end{proof}
{\bf Remark}: Since $V\subseteq\tv$, whenever $\sigma$ is a map 
$\sigma:V\to V$, it is also a map $\sigma:V\to\tv$ and given $\phi\in\tv$
it is therefore meaningful to ask whether $\sigma$ is valid for $\phi$ 
in the sense of definition~(\ref{logic:def:LAM:valid:substitution}), 
and whether it is $\beta$-valid for $\phi$ in the sense of 
definition~(\ref{logic:def:LAM:beta:valid:substitution}). These two
notions do not imply each other. For example, take $\phi=\lambda x y$
for some $x,y\in V$, $x\neq y$. Any $\sigma:V\to V$ will always be
both valid and $\beta$-valid for the formula $y$. However, using
proposition~(\ref{logic:prop:LAM:valid:recursion:quant}) we see that
$\sigma$ is valid for $\phi$ \ifand\ $\sigma(y)\neq\sigma(x)$. This makes
sense since the substitution $\sigma(\phi)$ as per 
definition~(\ref{logic:def:LAM:substitution}) is $\lambda\sigma(x)\sigma(y)$
and we need the condition $\sigma(y)\neq\sigma(x)$ to avoid variable
capture. However, using 
proposition~(\ref{logic:prop:LAM:beta:valid:recursion:lam}) we see that 
$\sigma$ is $\beta$-valid for $\phi$ \ifand\ $\sigma(y)\neq x$.
This also makes sense as the $\beta$-substitution (also denoted $\sigma(\phi)$)
as per definition~(\ref{logic:def:LAM:beta:subst}) is $\lambda x \sigma(y)$
and we need the condition $\sigma(y)\neq x$ to avoid variable capture. In any
case, it very easy to find a function $\sigma:V\to V$ which is valid but not 
$\beta$-valid for $\phi$ and vice-versa.

\begin{prop}\label{logic:prop:LAM:beta:validsub:criterion}
    Let $V$ be a set and $\sigma:V\to\tv$ be a map. Let $\phi\in\tv$.
    Then $\sigma$ is $\beta$-valid for $\phi$ \ifand\ for all $\phi_{1}\in\tv$
    and $x\in V$ we have:
    \[
        (\lambda x\phi_{1}\preceq\phi)\
            \Rightarrow\ 
            [\ 
                u\in\free(\lambda x\phi_{1})\ 
                    \Rightarrow
                x\not\in\free(\sigma(u))
            \ ]
    \]
\end{prop}
\begin{proof}
    First we prove the 'only if' part: So suppose $\sigma$ is $\beta$-valid for
    $\phi$. Let $\phi_{1}\in\tv$ and $x\in V$ such that 
    $\psi=\lambda x\phi_{1}\preceq\phi$ and let $u\in\free(\psi)$. We need to
    show that $x\not\in\free(\sigma(u))$. However, using
    definition~(\ref{logic:def:LAM:beta:valid:substitution}) from the
    $\beta$-validity of $\sigma$ for $\phi$ we have 
    $\free(\sigma(u))\subseteq\free(\sigma(\psi))$. It is therefore sufficient
    to show that $\free(\sigma(\psi))\subseteq\{x\}^{c}$ which follows from the
    following derivation:
        \begin{eqnarray*}\free(\sigma(\psi))
            &=&\free(\sigma(\lambda x\phi_{1}))\\
            \mbox{definition~(\ref{logic:def:LAM:beta:subst})\ $\rightarrow$\ }
            &=&\free(\,\sigma^{*}(\lambda x\phi_{1})(\emptyset)\,)\\
            &=&\free(\,\lambda x\sigma^{*}(\phi_{1})(\{x\})\,)\\
            &=&\free(\,\sigma^{*}(\phi_{1})(\{x\})\,)\,\setminus\,\{x\}\\
            &\subseteq&\{x\}^{c}
        \end{eqnarray*}
    We now prove the 'if' part: Consider the property $P_{\sigma}(\phi)$
    defined by:
    \[
        \forall\phi_{1}\forall x\ 
            [\ (\lambda x\phi_{1}\preceq\phi)\ 
                    \Rightarrow\ 
                [\
                    u\in\free(\lambda x\phi_{1})\ 
                        \Rightarrow\
                    x\not\in\free(\sigma(u))
                \ ]
            \ ]
    \]
    Then we need to prove that $P_{\sigma}(\phi)\ \Rightarrow\ (\mbox{$\sigma$
    $\beta$-valid for $\phi$})$ for all $\phi\in\tv$. We shall do so by structural 
    induction, using theorem~(\ref{logic:the:proof:induction}) of
    page~\pageref{logic:the:proof:induction}. First we assume that $\phi=x$
    for some $x\in V$. We need to show that the implication is true for $\phi$.
    So suppose $P_{\sigma}(\phi)$ is true. We need to show that $\sigma$ is 
    $\beta$-valid for $\phi$, which is always the case when $\phi=x$. This 
    completes our base case.
    Next we assume that $\phi=\phi_{1}\ \phi_{2}$ where the implication is true
    for $\phi_{1},\phi_{2}\in\tv$. We need to show that the implication is also 
    true for $\phi$. So we assume that $P_{\sigma}(\phi)$ is true. We need to 
    show that $\sigma$ is $\beta$-valid for $\phi=\phi_{1}\ \phi_{2}$. Using
    proposition~(\ref{logic:prop:LAM:beta:valid:recursion:app}) it is 
    sufficient to prove that $\sigma$ is $\beta$-valid for both $\phi_{1}$
    and $\phi_{2}$. Having assumed the implication is true for $\phi_{1}$
    and $\phi_{2}$, it is therefore sufficient to prove that 
    $P_{\sigma}(\phi_{1})$ and $P_{\sigma}(\phi_{2})$ are true. First we 
    show that $P_{\sigma}(\phi_{1})$ is true. So let $\psi\in\tv$ and 
    $z\in V$ such that $\lambda z\psi\preceq\phi_{1}$. Suppose
    $u\in\free(\lambda z\psi)$. We need to show that $z\not\in\free(\sigma(u))$.
    Having assumed that $P_{\sigma}(\phi)$ is true, it is sufficient to prove
    that $\lambda z\psi\preceq\phi$, which follows immediately from 
    $\lambda z\psi\preceq\phi_{1}$ and $\phi_{1}\preceq\phi$. So we have proved
    that $P_{\sigma}(\phi_{1})$ is indeed true and a similar argument shows that
    $P_{\sigma}(\phi_{2})$ is true. This concludes the case when $\phi=\phi_{1}\
    \phi_{2}$. Next we assume that $\phi=\lambda x\phi_{1}$ where $x\in V$ and 
    the implication is true for $\phi_{1}\in\tv$. We need to show that the 
    implication is also true for $\phi$. So we assume that $P_{\sigma}(\phi)$
    is true. We need to show that $\sigma$ is $\beta$-valid for $\phi=
    \lambda x\phi_{1}$. Using 
    proposition~(\ref{logic:prop:LAM:beta:valid:recursion:lam}) it is sufficient
    to prove that $\sigma$ is $\beta$-valid for $\phi_{1}$ and furthermore that
    $x\not\in\free(\sigma(u))$ whenever $u\in\free(\lambda x\phi_{1})$. First
    we show that $\sigma$ is $\beta$-valid for $\phi_{1}$. Having assumed the
    implication is true for $\phi_{1}$, it is sufficient to prove that 
    $P_{\sigma}(\phi_{1})$ is true. So let $\psi\in\tv$ and $z\in V$ such that
    $\lambda z\psi\preceq\phi_{1}$. Suppose $u\in\free(\lambda z\psi)$. We 
    need to show that $z\not\in\free(\sigma(u))$. Having assumed that
    $P_{\sigma}(\phi)$ is true, it is sufficient to prove that $\lambda z\psi
    \preceq\phi$, which follows immediately from $\lambda z\psi\preceq\phi_{1}$
    and $\phi_{1}\preceq\phi$. So we have proved that $P_{\sigma}(\phi_{1})$ is
    indeed true and $\sigma$ is therefore $\beta$-valid for $\phi_{1}$.
    Next we show that $x\not\in\free(\sigma(u))$ whenever $u\in\free(\lambda
    x\phi_{1})$. So let $u\in\free(\lambda x\phi_{1})$. We need to show that 
    $x\not\in\free(\sigma(u))$. Having assumed that $P_{\sigma}(\phi)$ is 
    true, it is sufficient to prove that $\lambda x\phi_{1}\preceq\phi$ which
    is immediate since $\lambda x\phi_{1}=\phi$.
\end{proof}

\begin{prop}\label{logic:prop:LAM:beta:validsub:singlevar}
    Let $V$ be a set, $x\in V$ and $\theta,\phi\in\tv$. Then we have:
        \[
            \free(\theta)\cap\var(\phi)=\emptyset\
                \Rightarrow
            (\mbox{$[\theta/x]$ $\beta$-valid for $\phi$})
        \]
\end{prop}
\begin{proof}
    We assume that $\free(\theta)\cap\var(\phi)=\emptyset$. We shall prove
    that $[\theta/x]$ is $\beta$-valid for $\phi$ using 
    proposition~(\ref{logic:prop:LAM:beta:validsub:criterion}). 
    So let $z\in V$ and $\phi_{1}\in\tv$ such that $\lambda z\phi_{1}
    \preceq\phi$ and let $u\in\free(\lambda z\phi_{1})$. We need to show 
    that $z\not\in\free([\theta/x](u))$. So first we assume that $u\neq x$. 
    Then from definition~(\ref{logic:def:LAM:single:var:beta:subst}) we have
    $[\theta/x](u)=u$ and since $\free(u)=\{u\}$ we simply need to show that
    $z\not\in\{u\}$ that is $z\neq u$, which follows from $u\in\free(\lambda
    z\phi_{1})=\free(\phi_{1})\setminus\{z\}$. So we now assume that $u=x$.
    Then $[\theta/x](u)=\theta$ and we need to show that $z\not\in\free(\theta)$.
    Having assumed that $\free(\theta)\cap\var(\phi)=\emptyset$, it is sufficient
    to prove that $z\in\var(\phi)$ which is clear since $z\in\var(\lambda z
    \phi_{1})$ and $\var(\lambda z\phi_{1})\subseteq\var(\phi)$, the latter
    inclusion being a consequence of the assumption $\lambda z\phi_{1}\preceq
    \phi$ and proposition~(\ref{logic:prop:LAM:variable:subformula}).
\end{proof}

\begin{prop}\label{logic:prop:LAM:beta:valid:composition:gen}
    Let $V$ be a set, $U\subseteq U' \subseteq V$ and $\sigma,\tau:V\to\tv$ 
    be maps. Let $\phi\in\tv$. Then, if $\tau$ is $\beta$-valid for $\phi$ 
    we have:
        \[
            (\sigma_{*}(U')\circ\tau)_{*}(U)(\phi)
            =(\,\sigma_{*}(U')\circ\tau_{*}(U)\,)(\phi)
        \]
    where for all $\chi:V\to\tv$, the map $\chi_{*}$ denotes the flipped version 
    of $\chi^{*}$ defined by $\chi_{*}(U)(\phi)=\chi^{*}(\phi)(U)$, and where 
    $\chi^{*}$ is defined as per definition~(\ref{logic:def:LAM:beta:subst}).
\end{prop}
\begin{proof}
    We assume $\sigma,\tau:V\to\tv$ given and we consider the property
    $P_{\sigma,\tau}(\phi)$ which states that the equality is true for
    all subsets $U,U'$ of $V$ such that $U\subseteq U'$. We need to show
    the implcation $(\tau\mbox{\ is $\beta$-valid for\ }\phi)\ \Rightarrow\
    P_{\sigma,\tau}(\phi)$. We shall prove this implication by structural
    induction on $\phi$, using theorem~(\ref{logic:the:proof:induction})
    of page~\pageref{logic:the:proof:induction}.

    So first we assume that $\phi=x$ for some $x\in V$. Since $\tau$ is 
    always $\beta$-valid for $\phi$, we simply need to prove that the 
    equality holds for all $U\subseteq U'$. We shall distinguish two cases:
    first we assume that $x\in U$. Then we have:
        \begin{eqnarray*}(\sigma_{*}(U')\circ\tau)_{*}(U)(\phi)
            &=&(\sigma_{*}(U')\circ\tau)_{*}(U)(x)\\
            &=&(\sigma_{*}(U')\circ\tau)^{*}(x)(U)\\
            \mbox{def.~(\ref{logic:def:LAM:beta:subst}), $x\in U\ \to\ $}
            &=&x\\
            \mbox{$U\subseteq U'$ so $x\in U'\ \to\ $}
            &=&\sigma^{*}(x)(U')\\
            &=&\sigma_{*}(U')(x)\\
            \mbox{$x\in U\ \to\ $}
            &=&\sigma_{*}(U')(\,\tau^{*}(x)(U)\,)\\
            &=&\sigma_{*}(U')(\,\tau_{*}(U)(x)\,)\\
            &=&(\,\sigma_{*}(U')\circ \tau_{*}(U)\,)(x)\\
            &=&(\,\sigma_{*}(U')\circ \tau_{*}(U)\,)(\phi)
        \end{eqnarray*}
    We now assume that $x\not\in U$. Then we have:
        \begin{eqnarray*}(\sigma_{*}(U')\circ\tau)_{*}(U)(\phi)
            &=&(\sigma_{*}(U')\circ\tau)_{*}(U)(x)\\
            &=&(\sigma_{*}(U')\circ\tau)^{*}(x)(U)\\
            \mbox{def.~(\ref{logic:def:LAM:beta:subst}), $x\not\in U\ \to\ $}
            &=&(\sigma_{*}(U')\circ\tau)(x)\\
            &=&\sigma_{*}(U')(\tau(x))\\
            \mbox{$x\not\in U\ \to\ $}
            &=&\sigma_{*}(U')(\tau^{*}(x)(U))\\
            &=&\sigma_{*}(U')(\tau_{*}(U)(x))\\
            &=&(\,\sigma_{*}(U')\circ\tau_{*}(U)\,)(x)\\
            &=&(\,\sigma_{*}(U')\circ\tau_{*}(U)\,)(\phi)
        \end{eqnarray*}
    Next, we assume that $\phi=\phi_{1}\ \phi_{2}$ for some $\phi_{1},\phi_{2}
    \in\tv$ for which the implication is true. We need to show that the
    implication is also true for $\phi$. So we assume that $\tau$ is
    $\beta$-valid for $\phi$ and $U\subseteq U'$. We need to show the
    equality holds. Note that from 
    proposition~(\ref{logic:prop:LAM:beta:valid:recursion:app}), $\tau$ is
    $\beta$-valid for both $\phi_{1}$ and $\phi_{2}$ and having assumed
    the implication is true for these, so is the equality. Hence:
        \begin{eqnarray*}(\sigma_{*}(U')\circ\tau)_{*}(U)(\phi)
            &=&(\sigma_{*}(U')\circ\tau)_{*}(U)(\phi_{1}\ \phi_{2})\\
            &=&(\sigma_{*}(U')\circ\tau)^{*}(\phi_{1}\ \phi_{2})(U)\\
            \mbox{def.~(\ref{logic:def:LAM:beta:subst})\ $\to$\ }
            &=&(\sigma_{*}(U')\circ\tau)^{*}(\phi_{1})(U)\ \ 
               (\sigma_{*}(U')\circ\tau)^{*}(\phi_{2})(U)\\
            &=&(\sigma_{*}(U')\circ\tau)_{*}(U)(\phi_{1})\ \ 
               (\sigma_{*}(U')\circ\tau)_{*}(U)(\phi_{2})\\
            \mbox{induction hypothesis$\ \to\ $}
            &=&(\,\sigma_{*}(U')\circ\tau_{*}(U)\,)(\phi_{1})\ \ 
               (\,\sigma_{*}(U')\circ\tau_{*}(U)\,)(\phi_{2})\\
            &=&\sigma_{*}(U')(\,\tau_{*}(U)(\phi_{1})\,)\ \ 
               \sigma_{*}(U')(\,\tau_{*}(U)(\phi_{2})\,)\\
            &=&\sigma^{*}(\,\tau_{*}(U)(\phi_{1})\,)(U')\ \ 
               \sigma^{*}(\,\tau_{*}(U)(\phi_{2})\,)(U')\\
            \mbox{def.~(\ref{logic:def:LAM:beta:subst})\ $\to$\ }
            &=&\sigma^{*}(\,\tau_{*}(U)(\phi_{1})\ \ 
                            \tau_{*}(U)(\phi_{2})\,)(U')\\ 
            &=&\sigma^{*}(\,\tau^{*}(\phi_{1})(U)\ \ 
                            \tau^{*}(\phi_{2})(U)\,)(U')\\
            \mbox{def.~(\ref{logic:def:LAM:beta:subst})\ $\to$\ }
            &=&\sigma^{*}(\,\tau^{*}(\phi_{1}\ \phi_{2})(U)\,)(U')\\
            &=&\sigma^{*}(\,\tau^{*}(\phi)(U)\,)(U')\\
            &=&\sigma_{*}(U')(\,\tau_{*}(U)(\phi)\,)\\
            &=&(\,\sigma_{*}(U')\circ\tau_{*}(U)\,)(\phi)
        \end{eqnarray*}
    Finally, we assume that $\phi=\lambda x\phi_{1}$ for some $x\in V$, and
    some $\phi_{1}\in\tv$ for which the implication is true. We need to show
    that the implication is also true for $\phi$. So we assume that $\tau$ is
    $\beta$-valid for $\phi$ and $U\subseteq U'$. We need to show that the 
    equality holds. Note that from 
    proposition~(\ref{logic:prop:LAM:beta:valid:recursion:lam}), $\tau$ is
    $\beta$-valid for $\phi_{1}$ and having assumed the implication is true
    for $\phi_{1}$, so is the equality for all subsets $U\subseteq U'$.
    Hence, we have:
        \begin{eqnarray*}(\sigma_{*}(U')\circ\tau)_{*}(U)(\phi)
            &=&(\sigma_{*}(U')\circ\tau)_{*}(U)(\lambda x\phi_{1})\\
            &=&(\sigma_{*}(U')\circ\tau)^{*}(\lambda x\phi_{1})(U)\\
            \mbox{def.~(\ref{logic:def:LAM:beta:subst})\ $\to$\ }
            &=&\lambda x(\sigma_{*}(U')\circ\tau)^{*}(\phi_{1})(U\cup\{x\})\\
            \mbox{see below\ $\to$\ }
            &=&\lambda x(\sigma_{*}(U'\cup\{x\})\circ
                         \tau)^{*}(\phi_{1})(U\cup\{x\})\\
            &=&\lambda x(\sigma_{*}(U'\cup\{x\})\circ
                         \tau)_{*}(U\cup\{x\})(\phi_{1})\\
            \mbox{induction, $U\cup\{x\}\subseteq U'\cup\{x\}\ \to\ $}
            &=&\lambda x(\ \sigma_{*}(U'\cup\{x\})\,\circ\,
                           \tau_{*}(U\cup\{x\})\ )(\phi_{1})\\
            &=&\lambda x \sigma_{*}(U'\cup\{x\})(\,
                         \tau_{*}(U\cup\{x\})(\phi_{1})\,)\\
            &=&\lambda x \sigma^{*}(\,\tau_{*}(U\cup\{x\})(\phi_{1})\,)
                         (U'\cup\{x\})\\
            \mbox{def.~(\ref{logic:def:LAM:beta:subst})\ $\to$\ }
            &=&\sigma^{*}(\,\lambda x\tau_{*}(U\cup\{x\})(\phi_{1})\,)(U')\\
            &=&\sigma_{*}(U')(\,\lambda x\tau_{*}(U\cup\{x\})(\phi_{1})\,)\\
            &=&\sigma_{*}(U')(\,\lambda x\tau^{*}(\phi_{1})(U\cup\{x\})\,)\\
            \mbox{def.~(\ref{logic:def:LAM:beta:subst})\ $\to$\ }
            &=&\sigma_{*}(U')(\,\tau^{*}(\lambda x\phi_{1})(U)\,)\\
            &=&\sigma_{*}(U')(\,\tau^{*}(\phi)(U)\,)\\
            &=&\sigma_{*}(U')(\,\tau_{*}(U)(\phi)\,)\\
            &=&(\,\sigma_{*}(U')\circ\tau_{*}(U)\,)(\phi)
        \end{eqnarray*}
\end{proof}

